<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>T·ªïng K·∫øt L·ªõp - B√°o C√°o Sinh Ho·∫°t Tu·∫ßn</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="data.js"></script>
    <script src="config.js"></script>
    <style>
        html {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
                animation: none !important;
                background-position: 0% 50%;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: max(5px, env(safe-area-inset-left));
                padding-right: max(5px, env(safe-area-inset-right));
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }

            .container {
                margin-bottom: env(safe-area-inset-bottom);
                margin-left: 0;
                margin-right: 0;
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                border-radius: 0;
                max-width: 100%;
                width: 100%;
            }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #ffffff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }

        .back-home {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .back-home a {
            display: inline-block;
            padding: 10px 16px;
            border-radius: 8px;
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
        }

        .back-home a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        h1 {
            font-size: 2.2em;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            margin: 0 0 20px 0;
            letter-spacing: 0.5px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .week-selector {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #9c27b0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .week-selector label {
            display: block;
            color: #7b1fa2;
            font-size: 1.1em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .week-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .week-controls button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
            min-height: 44px;
            min-width: 44px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
        }

        #prevWeekBtn {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
        }

        #prevWeekBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 125, 50, 0.4);
        }

        #nextWeekBtn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3);
        }

        #nextWeekBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
        }

        #week {
            flex: 1;
            min-width: 80px;
            min-height: 44px;
            padding: 12px;
            border: 2px solid #9c27b0;
            border-radius: 10px;
            background: white;
            font-weight: 600;
            font-size: 1.1em;
            text-align: center;
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            touch-action: manipulation;
        }

        #week::-webkit-inner-spin-button,
        #week::-webkit-outer-spin-button {
            appearance: none;
            -webkit-appearance: none;
            margin: 0;
        }

        #week_date_range {
            text-align: center;
            margin-top: 10px;
            color: #7b1fa2;
            font-weight: 600;
            font-size: 1.05em;
        }

        .report-container {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .report-header h2 {
            font-size: 1.8em;
            color: #667eea;
            font-weight: 700;
            margin: 0;
            line-height: 1.4;
        }

        .report-header .week-info {
            font-size: 1.1em;
            color: #666;
            margin-top: 10px;
            font-weight: 500;
        }

        .report-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.4em;
            color: #667eea;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .report-item {
            margin-bottom: 15px;
            padding-left: 20px;
            line-height: 1.8;
            color: #333;
        }

        .report-item strong {
            color: #667eea;
            font-weight: 600;
        }

        .report-item ul {
            margin: 10px 0;
            padding-left: 30px;
        }

        .report-item li {
            margin-bottom: 8px;
            line-height: 1.8;
        }

        .report-item ul ul {
            margin-top: 6px;
            margin-bottom: 6px;
            padding-left: 25px;
            list-style-type: circle;
        }

        .report-item ul ul li {
            margin-bottom: 6px;
            line-height: 1.7;
            font-size: 0.95em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
            font-size: 1.1em;
        }

        .empty-data {
            color: #999;
            font-style: italic;
        }

        .highlight-positive {
            color: #4caf50;
            font-weight: 600;
        }

        .highlight-negative {
            color: #f5576c;
            font-weight: 600;
        }

        .highlight-warning {
            color: #ff9800;
            font-weight: 600;
        }

        .copy-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .copy-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .copy-button:active {
            transform: translateY(-1px);
        }

        .copy-button.copied {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        }

        @media (max-width: 768px) {
            .copy-button {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                font-size: 0.9em;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.5em;
            }

            .report-container {
                padding: 15px;
            }

            .report-header h2 {
                font-size: 1.4em;
            }

            .section-title {
                font-size: 1.2em;
            }

            .report-item {
                font-size: 0.95em;
                padding-left: 15px;
            }

            .week-controls {
                flex-wrap: nowrap !important;
                gap: 6px;
            }

            #prevWeekBtn {
                padding: 10px 12px !important;
                min-width: 45px;
                font-size: 0 !important;
            }

            #prevWeekBtn::before {
                content: '‚óÄ';
                font-size: 18px !important;
                display: inline-block;
                line-height: 1;
            }

            #nextWeekBtn {
                padding: 10px 12px !important;
                min-width: 45px;
                font-size: 0 !important;
            }

            #nextWeekBtn::after {
                content: '‚ñ∂';
                font-size: 18px !important;
                display: inline-block;
                line-height: 1;
            }

            #week {
                min-width: 70px !important;
                font-size: 0.95em !important;
                flex: 1 1 auto;
                padding: 10px !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="back-home">
            <a href="index.html">‚Üê Tr·ªü v·ªÅ trang ch·ªß</a>
        </div>
        <h1>üìä T·ªîNG K·∫æT L·ªöP</h1>

        <div class="week-selector">
            <label for="week">üìÖ TU·∫¶N TH·ª®</label>
            <div class="week-controls">
                <button type="button" id="prevWeekBtn" onclick="viewPreviousWeek()">‚óÄ Tu·∫ßn tr∆∞·ªõc</button>
                <input type="number" id="week" name="week" min="1" max="35" required oninput="updateWeekDateRange(); loadReport();">
                <button type="button" id="nextWeekBtn" onclick="viewNextWeek()">Tu·∫ßn sau ‚ñ∂</button>
            </div>
            <div id="week_date_range"></div>
        </div>

        <div id="reportContainer" class="report-container">
            <div class="loading">ƒêang t·∫£i b√°o c√°o...</div>
        </div>
        
        <button id="copyButton" class="copy-button" onclick="copyReport()" style="display: none;">
            <span>üìã</span>
            <span id="copyButtonText">Copy b√°o c√°o</span>
        </button>
    </div>

    <script>
        // Helper function ƒë·ªÉ l·∫•y week range string
        function getWeekRangeString(weekNumber) {
            if (typeof SCHOOL_WEEKS_CONFIG === 'undefined' || !SCHOOL_WEEKS_CONFIG) {
                return '';
            }
            if (weekNumber < 1 || weekNumber > SCHOOL_WEEKS_CONFIG.length) {
                return '';
            }
            const weekConfig = SCHOOL_WEEKS_CONFIG[weekNumber - 1];
            if (!weekConfig) return '';
            return `t·ª´ ng√†y ${weekConfig.from} ƒë·∫øn ${weekConfig.to}`;
        }

        function updateWeekDateRange() {
            const weekInput = document.getElementById('week');
            if (!weekInput) return;
            
            const weekValue = parseInt(weekInput.value) || 0;
            const weekDateRange = document.getElementById('week_date_range');
            
            if (!weekDateRange) return;
            
            if (weekValue >= 1 && weekValue <= 35) {
                const rangeString = getWeekRangeString(weekValue);
                if (rangeString) {
                    weekDateRange.textContent = rangeString;
                } else {
                    if (typeof SCHOOL_WEEKS_CONFIG === 'undefined') {
                        setTimeout(updateWeekDateRange, 200);
                    } else {
                        weekDateRange.textContent = 'Kh√¥ng t√¨m th·∫•y th√¥ng tin tu·∫ßn ' + weekValue;
                    }
                }
            } else {
                weekDateRange.textContent = '';
            }
        }

        function viewPreviousWeek() {
            const currentWeek = parseInt(document.getElementById('week').value) || 1;
            if (currentWeek > 1) {
                document.getElementById('week').value = currentWeek - 1;
                updateWeekDateRange();
                loadReport();
            } else {
                alert('ƒê√¢y l√† tu·∫ßn ƒë·∫ßu ti√™n!');
            }
        }

        function viewNextWeek() {
            const currentWeek = parseInt(document.getElementById('week').value) || 1;
            const maxWeek = typeof SCHOOL_WEEKS_CONFIG !== 'undefined' && SCHOOL_WEEKS_CONFIG ? SCHOOL_WEEKS_CONFIG.length : 35;
            if (currentWeek < maxWeek) {
                document.getElementById('week').value = currentWeek + 1;
                updateWeekDateRange();
                loadReport();
            } else {
                alert('ƒê√¢y l√† tu·∫ßn cu·ªëi c√πng!');
            }
        }

        // T√≠nh tu·∫ßn hi·ªán t·∫°i d·ª±a tr√™n ng√†y th√°ng
        function getCurrentWeek() {
            if (typeof getCurrentWeekNumber === 'function' && typeof SCHOOL_WEEKS_CONFIG !== 'undefined') {
                return getCurrentWeekNumber();
            }
            
            if (typeof SCHOOL_WEEKS_CONFIG === 'undefined' || !SCHOOL_WEEKS_CONFIG || SCHOOL_WEEKS_CONFIG.length === 0) {
                return 1;
            }
            
            const today = new Date();
            const currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            currentDate.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < SCHOOL_WEEKS_CONFIG.length; i++) {
                const weekConfig = SCHOOL_WEEKS_CONFIG[i];
                if (!weekConfig || !weekConfig.from || !weekConfig.to) continue;
                
                const [fromDay, fromMonth, fromYear] = weekConfig.from.split('/').map(Number);
                const [toDay, toMonth, toYear] = weekConfig.to.split('/').map(Number);
                
                if (isNaN(fromDay) || isNaN(fromMonth) || isNaN(fromYear) || 
                    isNaN(toDay) || isNaN(toMonth) || isNaN(toYear)) {
                    continue;
                }
                
                const startDate = new Date(fromYear, fromMonth - 1, fromDay);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(toYear, toMonth - 1, toDay);
                endDate.setHours(23, 59, 59, 999);
                
                if (currentDate >= startDate && currentDate <= endDate) {
                    return weekConfig.week;
                }
            }
            
            for (let i = SCHOOL_WEEKS_CONFIG.length - 1; i >= 0; i--) {
                const weekConfig = SCHOOL_WEEKS_CONFIG[i];
                if (!weekConfig || !weekConfig.from) continue;
                
                const [fromDay, fromMonth, fromYear] = weekConfig.from.split('/').map(Number);
                if (isNaN(fromDay) || isNaN(fromMonth) || isNaN(fromYear)) continue;
                
                const startDate = new Date(fromYear, fromMonth - 1, fromDay);
                startDate.setHours(0, 0, 0, 0);
                
                if (startDate <= currentDate) {
                    return weekConfig.week;
                }
            }
            
            return 1;
        }

        // Parse CSV text th√†nh m·∫£ng d·ªØ li·ªáu
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                data.push(values);
            }
            
            return data;
        }

        // L·∫•y d·ªØ li·ªáu t·ª´ sheet CSV
        async function fetchSheetData(gid) {
            try {
                if (!gid || !PUBLISHED_SPREADSHEET_URL) {
                    return null;
                }

                const csvUrl = `${PUBLISHED_SPREADSHEET_URL}/pub?gid=${gid}&single=true&output=csv`;
                
                let csvText = null;
                try {
                    const response = await fetch(csvUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        csvText = await response.text();
                    }
                } catch (directError) {
                    console.log(`Direct fetch failed, trying proxy...`);
                }

                if (!csvText) {
                    try {
                        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`;
                        const proxyResponse = await fetch(proxyUrl);
                        
                        if (proxyResponse.ok) {
                            const proxyData = await proxyResponse.json();
                            if (proxyData.contents) {
                                csvText = proxyData.contents;
                            }
                        }
                    } catch (proxyError) {
                        console.error(`Proxy fetch failed:`, proxyError);
                    }
                }

                if (!csvText) {
                    return null;
                }

                return parseCSV(csvText);
            } catch (error) {
                console.error(`Error fetching sheet data:`, error);
                return null;
            }
        }

        // L·∫•y gi√° tr·ªã t·ª´ m·ªôt c·ªôt c·ª• th·ªÉ trong sheet
        function getColumnValue(csvData, week, columnIndex) {
            if (!csvData || csvData.length < 2) return '';
            
            const weekStr = String(week);
            
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    return row[columnIndex] ? String(row[columnIndex]).trim() : '';
                }
            }
            
            return '';
        }

        // L·∫•y d·ªØ li·ªáu t·ª´ nhi·ªÅu sheet v√† t·ªïng h·ª£p
        async function gatherAllData(week) {
            const data = {
                ranking: null,      // C·ªôt F t·ª´ Ranking sheet
                lt: null,            // Sheet LT
                lpht: null,          // Sheet LPHT
                lptt: null,          // Sheet LPTT
                lppt: null,          // Sheet LPPT
                lpld: null,          // Sheet LPLD
                tt1: null,           // Sheet TT1
                tt2: null,           // Sheet TT2
                tt3: null,           // Sheet TT3
                tt4: null,           // Sheet TT4
                thuquy: null         // Sheet ThuQuy
            };

            // L·∫•y GID t·ª´ config
            const gidMap = {
                ranking: typeof RANKING_SHEET_GID !== 'undefined' ? RANKING_SHEET_GID : null,
                lt: typeof LT_SHEET_GID !== 'undefined' ? LT_SHEET_GID : null,
                lpht: typeof LPHT_SHEET_GID !== 'undefined' ? LPHT_SHEET_GID : null,
                lptt: typeof LPTT_SHEET_GID !== 'undefined' ? LPTT_SHEET_GID : null,
                lppt: typeof LPPT_SHEET_GID !== 'undefined' ? LPPT_SHEET_GID : null,
                lpld: typeof LPLD_SHEET_GID !== 'undefined' ? LPLD_SHEET_GID : null,
                tt1: typeof TT1_SHEET_GID !== 'undefined' ? TT1_SHEET_GID : null,
                tt2: typeof TT2_SHEET_GID !== 'undefined' ? TT2_SHEET_GID : null,
                tt3: typeof TT3_SHEET_GID !== 'undefined' ? TT3_SHEET_GID : null,
                tt4: typeof TT4_SHEET_GID !== 'undefined' ? TT4_SHEET_GID : null,
                thuquy: typeof THUQUY_SHEET_GID !== 'undefined' ? THUQUY_SHEET_GID : null
            };

            // Fetch t·∫•t c·∫£ song song
            const promises = [];
            for (const [key, gid] of Object.entries(gidMap)) {
                if (gid) {
                    promises.push(fetchSheetData(gid).then(result => {
                        data[key] = result;
                    }));
                }
            }

            await Promise.all(promises);
            return data;
        }

        // Format s·ªë ti·ªÅn
        function formatCurrency(value) {
            if (!value || value === '') return '0';
            const num = parseFloat(value.toString().replace(/[^\d.-]/g, ''));
            if (isNaN(num)) return value;
            return new Intl.NumberFormat('vi-VN').format(num) + ' ƒë';
        }

        // T·∫°o HTML b√°o c√°o
        function generateReportHTML(week, weekRange, allData) {
            const weekStr = String(week);
            
            // L·∫•y c√°c gi√° tr·ªã t·ª´ c√°c sheet
            // Ranking: C·ªôt F (index 5) ch·ª©a k·∫øt qu·∫£ h·∫°ng
            let rankingResult = getColumnValue(allData.ranking, week, 5); // C·ªôt F (index 5)
            // N·∫øu kh√¥ng c√≥ t·ª´ c·ªôt F, th·ª≠ t√≠nh t·ª´ ƒëi·ªÉm s·ªë c√°c t·ªï
            if (!rankingResult || rankingResult.trim() === '') {
                const t1Score = parseFloat(getColumnValue(allData.ranking, week, 1)) || 0; // C·ªôt B
                const t2Score = parseFloat(getColumnValue(allData.ranking, week, 2)) || 0; // C·ªôt C
                const t3Score = parseFloat(getColumnValue(allData.ranking, week, 3)) || 0; // C·ªôt D
                const t4Score = parseFloat(getColumnValue(allData.ranking, week, 4)) || 0; // C·ªôt E
                
                const scores = [
                    { name: 'T·ªï 1', score: t1Score },
                    { name: 'T·ªï 2', score: t2Score },
                    { name: 'T·ªï 3', score: t3Score },
                    { name: 'T·ªï 4', score: t4Score }
                ];
                
                scores.sort((a, b) => b.score - a.score);
                const maxScore = scores[0].score;
                const winners = scores.filter(s => s.score === maxScore && maxScore > 0);
                
                if (winners.length > 0) {
                    rankingResult = winners.map(w => w.name).join(', ') + ' ƒë·∫°t h·∫°ng nh·∫•t, ƒë∆∞·ª£c khen th∆∞·ªüng v√† tuy√™n d∆∞∆°ng';
                }
            } else {
                // Format l·∫°i n·∫øu c√≥ d·ªØ li·ªáu
                rankingResult = rankingResult + ', ƒë∆∞·ª£c khen th∆∞·ªüng v√† tuy√™n d∆∞∆°ng';
            }
            
            // LT data - ƒë·∫ßy ƒë·ªß c√°c c·ªôt
            const ltNoticeGuild = getColumnValue(allData.lt, week, 2); // C·ªôt C: Th√¥ng b√°o b√™n ƒëo√†n
            const ltAbsent = getColumnValue(allData.lt, week, 3); // C·ªôt D: H·ªçc sinh v·∫Øng
            const ltLate = getColumnValue(allData.lt, week, 4); // C·ªôt E: H·ªçc sinh tr·ªÖ
            const ltViolation = getColumnValue(allData.lt, week, 5); // C·ªôt F: Vi ph·∫°m b√™n ƒëo√†n
            const ltFuturePlan = getColumnValue(allData.lt, week, 6); // C·ªôt G: Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau
            
            // LPHT data - ƒë·∫ßy ƒë·ªß c√°c c·ªôt
            const lphtGoodPoints = getColumnValue(allData.lpht, week, 2); // C·ªôt C: S·ªë ƒëi·ªÉm t·ªët
            const lphtParticipation = getColumnValue(allData.lpht, week, 3); // C·ªôt D: S·ªë l∆∞·ª£t ph√°t bi·ªÉu
            const lphtWarnedSubject = getColumnValue(allData.lpht, week, 4); // C·ªôt E: M√¥n h·ªçc b·ªã nh·∫Øc nh·ªü
            const lphtFuturePlan = getColumnValue(allData.lpht, week, 5); // C·ªôt F: Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau
            const lphtSuggestion = getColumnValue(allData.lpht, week, 6); // C·ªôt G: √ù ki·∫øn ƒë·ªÅ xu·∫•t
            
            // LPTT data - ƒë·∫ßy ƒë·ªß c√°c c·ªôt
            const lpttDisorderStudents = getColumnValue(allData.lptt, week, 2); // C·ªôt C: H·ªçc sinh MTT
            const lpttDisorderCount = getColumnValue(allData.lptt, week, 3); // C·ªôt D: S·ªë l∆∞·ª£t MTT
            const lpttDisorderSDB = getColumnValue(allData.lptt, week, 4); // C·ªôt E: MTT(SDB)
            const lpttDisorderSDBCount = getColumnValue(allData.lptt, week, 5); // C·ªôt F: S·ªë l∆∞·ª£t MTT(SDB)
            const lpttTeacherWarning = getColumnValue(allData.lptt, week, 6); // C·ªôt G: Theo d√µi gi√°o vi√™n nh·∫Øc
            
            // LPLD data - ƒë·∫ßy ƒë·ªß c√°c c·ªôt
            const lpldCleaningTeam = getColumnValue(allData.lpld, week, 2); // C·ªôt C: T·ªï tr·ª±c
            const lpldChairTeam = getColumnValue(allData.lpld, week, 3); // C·ªôt D: Mang gh·∫ø ra s√¢n
            const lpldMonday = getColumnValue(allData.lpld, week, 4); // C·ªôt E: Th·ª© 2
            const lpldTuesday = getColumnValue(allData.lpld, week, 5); // C·ªôt F: Th·ª© 3
            const lpldWednesday = getColumnValue(allData.lpld, week, 6); // C·ªôt G: Th·ª© 4
            const lpldThursday = getColumnValue(allData.lpld, week, 7); // C·ªôt H: Th·ª© 5
            const lpldFriday = getColumnValue(allData.lpld, week, 8); // C·ªôt I: Th·ª© 6
            const lpldSaturday = getColumnValue(allData.lpld, week, 9); // C·ªôt J: Th·ª© 7
            const lpldLateDuty = getColumnValue(allData.lpld, week, 10); // C·ªôt K: Tr·ª±c tr·ªÖ
            const lpldFeedback = getColumnValue(allData.lpld, week, 11); // C·ªôt L: √ù ki·∫øn
            
            // TT data - t·ªïng h·ª£p chi ti·∫øt t·ª´ 4 t·ªï
            const ttData = {
                notMemorized: [],
                notMemorizedCount: [],
                noHomework: [],
                noHomeworkCount: [],
                disorder: [],
                disorderCount: [],
                late: [],
                lateCount: [],
                violation: [],
                violationCount: [],
                absent: [],
                absentCount: [],
                goodPoints: [],
                goodPointsCount: [],
                participation: [],
                participationCount: [],
                totalPoints: []
            };
            
            ['tt1', 'tt2', 'tt3', 'tt4'].forEach((ttKey, index) => {
                if (allData[ttKey]) {
                    const notMemorized = getColumnValue(allData[ttKey], week, 2); // C·ªôt C
                    const notMemorizedCount = getColumnValue(allData[ttKey], week, 3); // C·ªôt D
                    const noHomework = getColumnValue(allData[ttKey], week, 4); // C·ªôt E
                    const noHomeworkCount = getColumnValue(allData[ttKey], week, 5); // C·ªôt F
                    const disorder = getColumnValue(allData[ttKey], week, 6); // C·ªôt G
                    const disorderCount = getColumnValue(allData[ttKey], week, 7); // C·ªôt H
                    const late = getColumnValue(allData[ttKey], week, 8); // C·ªôt I
                    const lateCount = getColumnValue(allData[ttKey], week, 9); // C·ªôt J
                    const violation = getColumnValue(allData[ttKey], week, 10); // C·ªôt K
                    const violationCount = getColumnValue(allData[ttKey], week, 11); // C·ªôt L
                    const absent = getColumnValue(allData[ttKey], week, 12); // C·ªôt M
                    const absentCount = getColumnValue(allData[ttKey], week, 13); // C·ªôt N
                    const goodPoints = getColumnValue(allData[ttKey], week, 14); // C·ªôt O
                    const goodPointsCount = getColumnValue(allData[ttKey], week, 15); // C·ªôt P
                    const participation = getColumnValue(allData[ttKey], week, 16); // C·ªôt Q
                    const participationCount = getColumnValue(allData[ttKey], week, 17); // C·ªôt R
                    const totalPoints = getColumnValue(allData[ttKey], week, 18); // C·ªôt S
                    
                    if (notMemorized) ttData.notMemorized.push({name: notMemorized, count: parseInt(notMemorizedCount) || 0, team: `T·ªï ${index + 1}`});
                    if (noHomework) ttData.noHomework.push({name: noHomework, count: parseInt(noHomeworkCount) || 0, team: `T·ªï ${index + 1}`});
                    if (disorder) ttData.disorder.push({name: disorder, count: parseInt(disorderCount) || 0, team: `T·ªï ${index + 1}`});
                    if (late) ttData.late.push({name: late, count: parseInt(lateCount) || 0, team: `T·ªï ${index + 1}`});
                    if (violation) ttData.violation.push({name: violation, count: parseInt(violationCount) || 0, team: `T·ªï ${index + 1}`});
                    if (absent) ttData.absent.push({name: absent, count: parseInt(absentCount) || 0, team: `T·ªï ${index + 1}`});
                    if (goodPoints) ttData.goodPoints.push({name: goodPoints, count: parseInt(goodPointsCount) || 0, team: `T·ªï ${index + 1}`});
                    if (participation) ttData.participation.push({name: participation, count: parseInt(participationCount) || 0, team: `T·ªï ${index + 1}`});
                    if (totalPoints) ttData.totalPoints.push({team: `T·ªï ${index + 1}`, points: totalPoints});
                }
            });
            
            // T√≠nh t·ªïng ƒëi·ªÉm t·ªët v√† ph√°t bi·ªÉu
            const totalGoodPoints = ttData.goodPoints.reduce((a, b) => a + (b.count || 0), 0);
            const totalParticipation = ttData.participation.reduce((a, b) => a + (b.count || 0), 0);
            const totalNotMemorizedCount = ttData.notMemorized.reduce((a, b) => a + (b.count || 0), 0);
            const totalNoHomeworkCount = ttData.noHomework.reduce((a, b) => a + (b.count || 0), 0);
            const totalDisorderCount = ttData.disorder.reduce((a, b) => a + (b.count || 0), 0);
            const totalLateCount = ttData.late.reduce((a, b) => a + (b.count || 0), 0);
            const totalViolationCount = ttData.violation.reduce((a, b) => a + (b.count || 0), 0);
            const totalAbsentCount = ttData.absent.reduce((a, b) => a + (b.count || 0), 0);
            
            // LPPT data - l·∫•y to√†n b·ªô
            const lpptCampaignName = getColumnValue(allData.lppt, week, 2); // C·ªôt C
            const lpptTime = getColumnValue(allData.lppt, week, 3); // C·ªôt D
            const lpptProgress = getColumnValue(allData.lppt, week, 4); // C·ªôt E
            const lpptAssigned = getColumnValue(allData.lppt, week, 5); // C·ªôt F
            const lpptCompetitionDate = getColumnValue(allData.lppt, week, 6); // C·ªôt G
            const lpptCost = getColumnValue(allData.lppt, week, 7); // C·ªôt H
            
            // ThuQuy data - ƒë·∫ßy ƒë·ªß c√°c c·ªôt
            const thuquyFeePerStudent = getColumnValue(allData.thuquy, week, 2); // C·ªôt C: Ti·ªÅn Thu /1HS
            const thuquyQuantityPaid = getColumnValue(allData.thuquy, week, 3); // C·ªôt D: S·ªë l∆∞·ª£ng ƒë√£ n·ªôp
            const thuquyMissingStudents = getColumnValue(allData.thuquy, week, 4); // C·ªôt E: H·ªçc sinh thi·∫øu
            const thuquyQuantityMissing = getColumnValue(allData.thuquy, week, 5); // C·ªôt F: S·ªë l∆∞·ª£ng thi·∫øu
            const thuquyExpenseName1 = getColumnValue(allData.thuquy, week, 6); // C·ªôt G: Chi 1
            const thuquyExpenseAmount1 = getColumnValue(allData.thuquy, week, 7); // C·ªôt H: S·ªë ti·ªÅn Chi 1
            const thuquyExpenseName2 = getColumnValue(allData.thuquy, week, 8); // C·ªôt I: Chi 2
            const thuquyExpenseAmount2 = getColumnValue(allData.thuquy, week, 9); // C·ªôt J: S·ªë ti·ªÅn Chi 2
            const thuquyExpenseName3 = getColumnValue(allData.thuquy, week, 10); // C·ªôt K: Chi 3
            const thuquyExpenseAmount3 = getColumnValue(allData.thuquy, week, 11); // C·ªôt L: S·ªë ti·ªÅn Chi 3
            const thuquyExpenseName4 = getColumnValue(allData.thuquy, week, 12); // C·ªôt M: Chi 4
            const thuquyExpenseAmount4 = getColumnValue(allData.thuquy, week, 13); // C·ªôt N: S·ªë ti·ªÅn Chi 4
            const thuquyTotalIncome = getColumnValue(allData.thuquy, week, 18); // C·ªôt S: T·ªïng thu
            const thuquyTotalExpense = getColumnValue(allData.thuquy, week, 19); // C·ªôt T: T·ªïng chi
            const thuquyRemaining = getColumnValue(allData.thuquy, week, 20); // C·ªôt U: S·ªë ti·ªÅn c√≤n l·∫°i
            
            // Ki·ªÉm tra ƒëi·ªÅu ki·ªán hi·ªÉn th·ªã
            const hasNotMemorized = ttData.notMemorized.length > 0;
            const hasNoHomework = ttData.noHomework.length > 0;
            const hasDisorder = (lpttDisorderStudents && lpttDisorderStudents.trim() !== '') || ttData.disorder.length > 0;
            const hasLateDuty = lpldLateDuty && lpldLateDuty.trim() !== '';
            const hasViolation = (ltViolation && ltViolation.trim() !== '') || ttData.violation.length > 0;
            const hasAbsent = (ltAbsent && ltAbsent.trim() !== '') || ttData.absent.length > 0;
            const hasLate = (ltLate && ltLate.trim() !== '') || ttData.late.length > 0;
            
            // T·∫°o danh s√°ch chi ti·∫øt c√°c kho·∫£n chi
            const expenses = [];
            if (thuquyExpenseName1 || thuquyExpenseAmount1) {
                expenses.push({name: thuquyExpenseName1 || 'Kh√¥ng c√≥ t√™n', amount: thuquyExpenseAmount1 || '0'});
            }
            if (thuquyExpenseName2 || thuquyExpenseAmount2) {
                expenses.push({name: thuquyExpenseName2 || 'Kh√¥ng c√≥ t√™n', amount: thuquyExpenseAmount2 || '0'});
            }
            if (thuquyExpenseName3 || thuquyExpenseAmount3) {
                expenses.push({name: thuquyExpenseName3 || 'Kh√¥ng c√≥ t√™n', amount: thuquyExpenseAmount3 || '0'});
            }
            if (thuquyExpenseName4 || thuquyExpenseAmount4) {
                expenses.push({name: thuquyExpenseName4 || 'Kh√¥ng c√≥ t√™n', amount: thuquyExpenseAmount4 || '0'});
            }
            
            // T·∫°o HTML
            let html = `
                <div class="report-header">
                    <h2>üìã B√ÅO C√ÅO SINH HO·∫†T TU·∫¶N ${week}</h2>
                    <div class="week-info">${weekRange}</div>
                </div>
                
                <div class="report-section">
                    <div class="section-title">I. T√åNH H√åNH H·ªåC SINH</div>
                    
                    <div class="report-item">
                        <strong>1. Thi ƒëua</strong>
                        <ul>
                            <li>C√°c t·ªï b√°o c√°o k·∫øt qu·∫£ thi ƒëua trong tu·∫ßn.</li>
                            <li>K·∫øt qu·∫£: ${rankingResult ? `<span class="highlight-positive">${rankingResult}</span>` : '<span class="empty-data">Ch∆∞a c√≥ d·ªØ li·ªáu thi ƒëua</span>'}</li>
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>2. H·ªçc t·∫≠p</strong>
                        <ul>
                            ${ttData.goodPoints.length > 0 ? `
                                <li>Bi·ªÉu d∆∞∆°ng h·ªçc sinh ƒëi·ªÉm t·ªët: 
                                    <ul style="margin-top: 8px; margin-bottom: 8px;">
                                        ${ttData.goodPoints.map(gp => `<li>${gp.name} (${gp.team}) - <span class="highlight-positive">${gp.count} ƒëi·ªÉm t·ªët</span></li>`).join('')}
                                    </ul>
                                    <strong>T·ªïng s·ªë ƒëi·ªÉm t·ªët:</strong> <span class="highlight-positive">${totalGoodPoints || 0}</span>
                                </li>
                            ` : '<li>Bi·ªÉu d∆∞∆°ng h·ªçc sinh ƒëi·ªÉm t·ªët: <span class="empty-data">kh√¥ng c√≥</span></li>'}
                            
                            ${ttData.participation.length > 0 ? `
                                <li>Bi·ªÉu d∆∞∆°ng h·ªçc sinh ph√°t bi·ªÉu: 
                                    <ul style="margin-top: 8px; margin-bottom: 8px;">
                                        ${ttData.participation.map(p => `<li>${p.name} (${p.team}) - <span class="highlight-positive">${p.count} l∆∞·ª£t ph√°t bi·ªÉu</span></li>`).join('')}
                                    </ul>
                                    <strong>T·ªïng s·ªë l∆∞·ª£t ph√°t bi·ªÉu:</strong> <span class="highlight-positive">${totalParticipation || 0}</span>
                                </li>
                            ` : '<li>Bi·ªÉu d∆∞∆°ng h·ªçc sinh ph√°t bi·ªÉu: <span class="empty-data">kh√¥ng c√≥</span></li>'}
                            
                            ${lphtWarnedSubject || lpttTeacherWarning || lpldFeedback ? `
                                <li>M√¥n h·ªçc b·ªã gi√°o vi√™n nh·∫Øc nh·ªü: 
                                    ${lphtWarnedSubject ? `<span class="highlight-warning">${lphtWarnedSubject}</span>` : ''}
                                    ${lpttTeacherWarning ? `<span class="highlight-warning">${lpttTeacherWarning}</span>` : ''}
                                    ${lpldFeedback ? `<span class="highlight-warning">${lpldFeedback}</span>` : ''}
                                </li>
                            ` : '<li>M√¥n h·ªçc b·ªã gi√°o vi√™n nh·∫Øc nh·ªü: <span class="highlight-positive">Kh√¥ng c√≥</span></li>'}
                            
                            ${hasNotMemorized || hasNoHomework ? `
                                <li><span class="highlight-warning">C√°c tr∆∞·ªùng h·ª£p vi ph·∫°m:</span>
                                    <ul style="margin-top: 8px;">
                                        ${hasNotMemorized ? `<li>Kh√¥ng thu·ªôc b√†i: ${ttData.notMemorized.map(nm => `${nm.name} (${nm.team}, ${nm.count} l∆∞·ª£t)`).join(', ')} - <strong>T·ªïng:</strong> ${totalNotMemorizedCount} l∆∞·ª£t</li>` : ''}
                                        ${hasNoHomework ? `<li>Kh√¥ng l√†m b√†i t·∫≠p: ${ttData.noHomework.map(nh => `${nh.name} (${nh.team}, ${nh.count} l∆∞·ª£t)`).join(', ')} - <strong>T·ªïng:</strong> ${totalNoHomeworkCount} l∆∞·ª£t</li>` : ''}
                                    </ul>
                                </li>
                            ` : '<li><span class="highlight-positive">ƒêa s·ªë h·ªçc sinh h·ªçc b√†i v√† l√†m b√†i t·∫≠p ƒë·∫ßy ƒë·ªß, chu·∫©n b·ªã b√†i theo y√™u c·∫ßu c·ªßa gi√°o vi√™n.</span></li>'}
                            
                            ${hasDisorder ? `<li><span class="highlight-warning">M·ªôt s·ªë h·ªçc sinh c·∫ßn t·∫≠p trung h∆°n trong gi·ªù h·ªçc.</span></li>` : ''}
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>3. Tr·∫≠t t·ª±</strong>
                        <ul>
                            ${lpttDisorderStudents || ttData.disorder.length > 0 ? `
                                <li>C√°c tr∆∞·ªùng h·ª£p m·∫•t tr·∫≠t t·ª±:
                                    <ul style="margin-top: 8px;">
                                        ${lpttDisorderStudents ? `<li>${lpttDisorderStudents} - S·ªë l∆∞·ª£t: ${lpttDisorderCount || '0'}</li>` : ''}
                                        ${lpttDisorderSDB ? `<li>MTT(SDB): ${lpttDisorderSDB} - S·ªë l∆∞·ª£t: ${lpttDisorderSDBCount || '0'}</li>` : ''}
                                        ${ttData.disorder.map(d => `<li>${d.name} (${d.team}) - S·ªë l∆∞·ª£t: ${d.count}</li>`).join('')}
                                    </ul>
                                    <strong>T·ªïng s·ªë l∆∞·ª£t:</strong> ${totalDisorderCount + (parseInt(lpttDisorderCount) || 0) + (parseInt(lpttDisorderSDBCount) || 0)}
                                </li>
                            ` : '<li><span class="highlight-positive">Kh√¥ng c√≥ vi ph·∫°m v·ªÅ tr·∫≠t t·ª±.</span></li>'}
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>4. Lao ƒë·ªông</strong>
                        <ul>
                            <li><strong>T·ªï tr·ª±c v·ªá sinh:</strong> ${lpldCleaningTeam || '<span class="empty-data">Ch∆∞a c√≥ d·ªØ li·ªáu</span>'}</li>
                            ${lpldChairTeam ? `<li><strong>Mang gh·∫ø ra s√¢n:</strong> ${lpldChairTeam}</li>` : ''}
                            ${lpldMonday || lpldTuesday || lpldWednesday || lpldThursday || lpldFriday || lpldSaturday ? `
                                <li><strong>L·ªãch tr·ª±c trong tu·∫ßn:</strong>
                                    <ul style="margin-top: 8px;">
                                        ${lpldMonday ? `<li>Th·ª© 2: ${lpldMonday}</li>` : ''}
                                        ${lpldTuesday ? `<li>Th·ª© 3: ${lpldTuesday}</li>` : ''}
                                        ${lpldWednesday ? `<li>Th·ª© 4: ${lpldWednesday}</li>` : ''}
                                        ${lpldThursday ? `<li>Th·ª© 5: ${lpldThursday}</li>` : ''}
                                        ${lpldFriday ? `<li>Th·ª© 6: ${lpldFriday}</li>` : ''}
                                        ${lpldSaturday ? `<li>Th·ª© 7: ${lpldSaturday}</li>` : ''}
                                    </ul>
                                </li>
                            ` : ''}
                            ${hasLateDuty ? `
                                <li><span class="highlight-warning">Tr·ª±c tr·ªÖ: ${lpldLateDuty}</span></li>
                            ` : '<li><span class="highlight-positive">Th·ª±c hi·ªán v·ªá sinh ƒë√∫ng gi·ªù, kh√¥ng b·ªã nh·∫Øc nh·ªü.</span></li>'}
                            ${lpldFeedback ? `<li><strong>√ù ki·∫øn:</strong> ${lpldFeedback}</li>` : ''}
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>5. ƒêi h·ªçc ƒë√∫ng gi·ªù</strong>
                        <ul>
                            ${hasAbsent ? `
                                <li><strong>V·∫Øng:</strong>
                                    <ul style="margin-top: 8px;">
                                        ${ltAbsent ? `<li>${ltAbsent}</li>` : ''}
                                        ${ttData.absent.map(a => `<li>${a.name} (${a.team}) - ${a.count} l∆∞·ª£t</li>`).join('')}
                                    </ul>
                                </li>
                            ` : '<li><strong>V·∫Øng:</strong> <span class="highlight-positive">Kh√¥ng c√≥</span></li>'}
                            
                            ${hasLate ? `
                                <li><strong>ƒêi tr·ªÖ:</strong>
                                    <ul style="margin-top: 8px;">
                                        ${ltLate ? `<li>${ltLate}</li>` : ''}
                                        ${ttData.late.map(l => `<li>${l.name} (${l.team}) - ${l.count} l∆∞·ª£t</li>`).join('')}
                                    </ul>
                                    <strong>T·ªïng s·ªë l∆∞·ª£t ƒëi tr·ªÖ:</strong> ${totalLateCount}
                                </li>
                            ` : '<li><strong>ƒêi tr·ªÖ:</strong> <span class="highlight-positive">Kh√¥ng c√≥</span></li>'}
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>6. Vi ph·∫°m b√™n ƒëo√†n</strong>
                        <ul>
                            ${hasViolation ? `
                                <li>C√°c tr∆∞·ªùng h·ª£p vi ph·∫°m:
                                    <ul style="margin-top: 8px;">
                                        ${ltViolation ? `<li>${ltViolation}</li>` : ''}
                                        ${ttData.violation.map(v => `<li>${v.name} (${v.team}) - ${v.count} l∆∞·ª£t</li>`).join('')}
                                    </ul>
                                    <strong>T·ªïng s·ªë l∆∞·ª£t vi ph·∫°m:</strong> ${totalViolationCount}
                                </li>
                            ` : '<li><span class="highlight-positive">Kh√¥ng c√≥ vi ph·∫°m b√™n ƒëo√†n.</span></li>'}
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>7. Phong tr√†o</strong>
                        <ul>
                            ${lpptCampaignName || lpptTime || lpptProgress ? `
                                ${lpptCampaignName ? `<li><strong>T√™n phong tr√†o:</strong> ${lpptCampaignName}</li>` : ''}
                                ${lpptTime ? `<li><strong>Th·ªùi gian th·ª±c hi·ªán:</strong> ${lpptTime}</li>` : ''}
                                ${lpptProgress ? `<li><strong>Ti·∫øn ƒë·ªô th·ª±c hi·ªán:</strong> ${lpptProgress}</li>` : ''}
                                ${lpptAssigned ? `<li><strong>Ph√¢n c√¥ng h·ªçc sinh ph·ª• tr√°ch:</strong> ${lpptAssigned}</li>` : ''}
                                ${lpptCompetitionDate ? `<li><strong>Ng√†y thi:</strong> ${lpptCompetitionDate}</li>` : ''}
                                ${lpptCost ? `<li><strong>D·ª± ki·∫øn kinh ph√≠:</strong> ${formatCurrency(lpptCost)}</li>` : ''}
                            ` : '<li><span class="empty-data">Ch∆∞a c√≥ th√¥ng tin phong tr√†o trong tu·∫ßn n√†y</span></li>'}
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>8. Qu·ªπ l·ªõp</strong>
                        <ul>
                            ${thuquyFeePerStudent ? `
                                <li><strong>Ti·ªÅn thu /1HS:</strong> ${formatCurrency(thuquyFeePerStudent)} - <strong>S·ªë l∆∞·ª£ng ƒë√£ n·ªôp:</strong> ${thuquyQuantityPaid || '0'} h·ªçc sinh</li>
                            ` : ''}
                            ${thuquyMissingStudents ? `
                                <li><strong>H·ªçc sinh thi·∫øu:</strong> ${thuquyMissingStudents} - <strong>S·ªë l∆∞·ª£ng:</strong> ${thuquyQuantityMissing || '0'} h·ªçc sinh</li>
                            ` : ''}
                            ${expenses.length > 0 ? `
                                <li><strong>C√°c kho·∫£n chi:</strong>
                                    <ul style="margin-top: 8px;">
                                        ${expenses.map((exp, idx) => `<li>Chi ${idx + 1}: ${exp.name} - <strong>S·ªë ti·ªÅn:</strong> ${formatCurrency(exp.amount)}</li>`).join('')}
                                    </ul>
                                </li>
                            ` : ''}
                            <li><strong>T·ªïng thu:</strong> ${thuquyTotalIncome ? formatCurrency(thuquyTotalIncome) : '<span class="empty-data">0</span>'}</li>
                            <li><strong>T·ªïng chi:</strong> ${thuquyTotalExpense && thuquyTotalExpense !== '0' ? formatCurrency(thuquyTotalExpense) : '0'} ${!thuquyTotalExpense || thuquyTotalExpense === '0' ? '(Kh√¥ng c√≥ chi)' : ''}</li>
                            <li><strong>C√≤n l·∫°i:</strong> <span class="highlight-positive">${thuquyRemaining ? thuquyRemaining : '<span class="empty-data">0</span>'}</span></li>
                        </ul>
                    </div>
                </div>
                
                <div class="report-section">
                    <div class="section-title">II. C√îNG T√ÅC GI√ÅO VI√äN CH·ª¶ NHI·ªÜM</div>
                    
                    <div class="report-item">
                        <strong>1. Nh·∫Øc nh·ªü v√† ƒë·ªãnh h∆∞·ªõng</strong>
                        <ul>
                            ${ltNoticeGuild ? `<li><strong>Th√¥ng b√°o b√™n ƒëo√†n:</strong> ${ltNoticeGuild}</li>` : ''}
                            ${hasDisorder ? '<li>Y√™u c·∫ßu h·ªçc sinh t·∫≠p trung h∆°n trong h·ªçc t·∫≠p, gi·ªØ tr·∫≠t t·ª± trong gi·ªù h·ªçc.</li>' : ''}
                            ${hasNotMemorized || hasNoHomework ? '<li>Nh·∫Øc l·∫°i n·ªôi quy h·ªçc t·∫≠p t·∫°i tr∆∞·ªùng, y√™u c·∫ßu h·ªçc sinh chu·∫©n b·ªã b√†i ƒë·∫ßy ƒë·ªß tr∆∞·ªõc khi ƒë·∫øn l·ªõp.</li>' : ''}
                            ${hasLate || hasAbsent ? '<li>Nh·∫Øc nh·ªü h·ªçc sinh ƒëi h·ªçc ƒë√∫ng gi·ªù, kh√¥ng v·∫Øng m·∫∑t kh√¥ng l√Ω do.</li>' : ''}
                            <li>Tuy√™n truy·ªÅn an to√†n giao th√¥ng, ch·∫•p h√†nh lu·∫≠t l·ªá khi tham gia giao th√¥ng.</li>
                            ${lpptCampaignName ? `<li>Th√¥ng b√°o v√† tri·ªÉn khai phong tr√†o: <strong>${lpptCampaignName}</strong>${lpptTime ? ` (${lpptTime})` : ''}</li>` : ''}
                            ${ltFuturePlan ? `<li><strong>Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau (LT):</strong> ${ltFuturePlan}</li>` : ''}
                            ${lphtFuturePlan ? `<li><strong>Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau (LPHT):</strong> ${lphtFuturePlan}</li>` : ''}
                            ${lphtSuggestion ? `<li><strong>√ù ki·∫øn ƒë·ªÅ xu·∫•t (LPHT):</strong> ${lphtSuggestion}</li>` : ''}
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>2. X·ª≠ l√Ω vi ph·∫°m</strong>
                        <ul>
                            ${hasViolation ? `
                                <li><strong>Ki·ªÉm ƒëi·ªÉm h·ªçc sinh vi ph·∫°m ƒëo√†n:</strong>
                                    <ul style="margin-top: 8px;">
                                        ${ltViolation ? `<li>${ltViolation}</li>` : ''}
                                        ${ttData.violation.map(v => `<li>${v.name} (${v.team}) - ${v.count} l∆∞·ª£t vi ph·∫°m</li>`).join('')}
                                    </ul>
                                </li>
                            ` : '<li><strong>Ki·ªÉm ƒëi·ªÉm h·ªçc sinh vi ph·∫°m ƒëo√†n:</strong> <span class="highlight-positive">Kh√¥ng c√≥.</span></li>'}
                            
                            ${hasNotMemorized || hasNoHomework ? `
                                <li><strong>Ki·ªÉm ƒëi·ªÉm h·ªçc sinh kh√¥ng thu·ªôc b√†i ho·∫∑c kh√¥ng l√†m b√†i:</strong>
                                    <ul style="margin-top: 8px;">
                                        ${hasNotMemorized ? `<li>Kh√¥ng thu·ªôc b√†i: ${ttData.notMemorized.map(nm => `${nm.name} (${nm.team})`).join(', ')} - T·ªïng ${totalNotMemorizedCount} l∆∞·ª£t</li>` : ''}
                                        ${hasNoHomework ? `<li>Kh√¥ng l√†m b√†i t·∫≠p: ${ttData.noHomework.map(nh => `${nh.name} (${nh.team})`).join(', ')} - T·ªïng ${totalNoHomeworkCount} l∆∞·ª£t</li>` : ''}
                                    </ul>
                                </li>
                            ` : '<li><strong>Ki·ªÉm ƒëi·ªÉm h·ªçc sinh kh√¥ng thu·ªôc b√†i ho·∫∑c kh√¥ng l√†m b√†i:</strong> <span class="highlight-positive">Kh√¥ng c√≥.</span></li>'}
                            
                            ${hasDisorder ? `
                                <li><strong>Nh·∫Øc nh·ªü c√°c tr∆∞·ªùng h·ª£p vi ph·∫°m n·ªôi quy:</strong>
                                    <ul style="margin-top: 8px;">
                                        ${lpttDisorderStudents ? `<li>M·∫•t tr·∫≠t t·ª±: ${lpttDisorderStudents} - ${lpttDisorderCount || '0'} l∆∞·ª£t</li>` : ''}
                                        ${lpttDisorderSDB ? `<li>MTT(SDB): ${lpttDisorderSDB} - ${lpttDisorderSDBCount || '0'} l∆∞·ª£t</li>` : ''}
                                        ${ttData.disorder.map(d => `<li>${d.name} (${d.team}) - ${d.count} l∆∞·ª£t</li>`).join('')}
                                    </ul>
                                </li>
                            ` : ''}
                            
                            ${hasLateDuty ? `<li><strong>X·ª≠ l√Ω tr∆∞·ªùng h·ª£p tr·ª±c tr·ªÖ:</strong> ${lpldLateDuty}</li>` : ''}
                            
                            <li>Ki·ªÉm ƒëi·ªÉm vi·ªác th·ª±c hi·ªán n·ªôi quy v√† n·ªÅ n·∫øp l·ªõp h·ªçc.</li>
                            <li>T·ªï ch·ª©c t·ªïng v·ªá sinh ph√≤ng h·ªçc sau ti·∫øt sinh ho·∫°t l·ªõp.</li>
                        </ul>
                    </div>
                    
                    <div class="report-item">
                        <strong>3. Bi·ªán ph√°p kh·∫Øc ph·ª•c</strong>
                        <ul>
                            ${hasNotMemorized || hasNoHomework || hasViolation ? `
                                <li><strong>X·ª≠ l√Ω vi ph·∫°m:</strong>
                                    <ul style="margin-top: 8px;">
                                        <li>Cho c√°c h·ªçc sinh vi ph·∫°m vi·∫øt t·ª± ki·ªÉm v√† cam k·∫øt kh√¥ng t√°i ph·∫°m.</li>
                                        <li>Th√¥ng b√°o cho ph·ª• huynh c√°c tr∆∞·ªùng h·ª£p vi ph·∫°m nghi√™m tr·ªçng.</li>
                                        <li>Theo d√µi s√°t sao c√°c h·ªçc sinh th∆∞·ªùng xuy√™n vi ph·∫°m.</li>
                                    </ul>
                                </li>
                            ` : ''}
                            
                            ${hasDisorder ? `
                                <li><strong>C·∫£i thi·ªán tr·∫≠t t·ª± l·ªõp h·ªçc:</strong>
                                    <ul style="margin-top: 8px;">
                                        <li>TƒÉng c∆∞·ªùng gi√°m s√°t, nh·∫Øc nh·ªü h·ªçc sinh n√≥i chuy·ªán ri√™ng trong gi·ªù h·ªçc.</li>
                                        <li>Ph√¢n c√¥ng l·∫°i v·ªã tr√≠ ng·ªìi cho c√°c h·ªçc sinh hay m·∫•t tr·∫≠t t·ª±.</li>
                                        <li>Ph·ªëi h·ª£p v·ªõi gi√°o vi√™n b·ªô m√¥n ƒë·ªÉ qu·∫£n l√Ω t·ªët h∆°n.</li>
                                    </ul>
                                </li>
                            ` : ''}
                            
                            ${hasLate || hasAbsent ? `
                                <li><strong>Gi·∫£m thi·ªÉu v·∫Øng m·∫∑t v√† ƒëi tr·ªÖ:</strong>
                                    <ul style="margin-top: 8px;">
                                        <li>Nh·∫Øc nh·ªü h·ªçc sinh ƒëi h·ªçc ƒë√∫ng gi·ªù, kh√¥ng v·∫Øng m·∫∑t kh√¥ng l√Ω do.</li>
                                        <li>Li√™n h·ªá v·ªõi ph·ª• huynh c√°c h·ªçc sinh th∆∞·ªùng xuy√™n v·∫Øng ho·∫∑c ƒëi tr·ªÖ.</li>
                                        <li>Ghi nh·∫≠n v√† khen th∆∞·ªüng c√°c h·ªçc sinh ƒëi h·ªçc ƒë·∫ßy ƒë·ªß, ƒë√∫ng gi·ªù.</li>
                                    </ul>
                                </li>
                            ` : ''}
                            
                            ${hasLateDuty ? `
                                <li><strong>C·∫£i thi·ªán c√¥ng t√°c lao ƒë·ªông:</strong>
                                    <ul style="margin-top: 8px;">
                                        <li>Nh·∫Øc nh·ªü t·ªï tr·ª±c th·ª±c hi·ªán ƒë√∫ng gi·ªù, kh√¥ng tr·ªÖ.</li>
                                        <li>Ki·ªÉm tra v√† ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng v·ªá sinh h√†ng ng√†y.</li>
                                        <li>Khen th∆∞·ªüng c√°c t·ªï th·ª±c hi·ªán t·ªët c√¥ng t√°c lao ƒë·ªông.</li>
                                    </ul>
                                </li>
                            ` : ''}
                            
                            <li><strong>Bi·ªán ph√°p chung:</strong>
                                <ul style="margin-top: 8px;">
                                    <li>ƒê·∫©y m·∫°nh tuy√™n truy·ªÅn √Ω th·ª©c h·ªçc t·∫≠p v√† ch·∫•p h√†nh n·ªôi quy.</li>
                                    <li>TƒÉng c∆∞·ªùng c√°c ho·∫°t ƒë·ªông gi√°o d·ª•c k·ªπ nƒÉng s·ªëng v√† gi√° tr·ªã s·ªëng.</li>
                                    <li>Khuy·∫øn kh√≠ch h·ªçc sinh t√≠ch c·ª±c tham gia c√°c ho·∫°t ƒë·ªông phong tr√†o.</li>
                                    <li>Duy tr√¨ v√† ph√°t huy nh·ªØng ƒëi·ªÉm t√≠ch c·ª±c ƒë√£ ƒë·∫°t ƒë∆∞·ª£c.</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <div class="report-section">
                    <div class="report-item" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #e0e0e0; background: #f9f9f9; padding: 15px; border-radius: 8px;">
                        <strong style="color: #667eea;">üìù Ghi ch√∫:</strong>
                        <ul style="margin-top: 10px; margin-bottom: 0;">
                            <li>Ti·∫øp t·ª•c theo d√µi v√† c·∫£i thi·ªán n·ªÅ n·∫øp l·ªõp h·ªçc trong tu·∫ßn t·ªõi.</li>
                            <li>Ph·ªëi h·ª£p ch·∫∑t ch·∫Ω v·ªõi Ban C√°n S·ª± L·ªõp ƒë·ªÉ qu·∫£n l√Ω t·ªët h∆°n.</li>
                            <li>ƒê·ªông vi√™n, kh√≠ch l·ªá h·ªçc sinh ph√°t huy nh·ªØng ƒëi·ªÉm t√≠ch c·ª±c.</li>
                            ${ttData.totalPoints.length > 0 ? `<li><strong>ƒêi·ªÉm thi ƒëua c√°c t·ªï:</strong> ${ttData.totalPoints.map(tp => `${tp.team}: ${tp.points} ƒëi·ªÉm`).join(', ')}</li>` : ''}
                        </ul>
                    </div>
                </div>
            `;
            
            return html;
        }

        // Copy to√†n b·ªô b√°o c√°o
        function copyReport() {
            const container = document.getElementById('reportContainer');
            if (!container) return;

            let text = '';
            
            // L·∫•y header
            const header = container.querySelector('.report-header h2');
            if (header) {
                text += header.textContent.trim() + '\n';
            }
            const weekInfo = container.querySelector('.report-header .week-info');
            if (weekInfo) {
                text += weekInfo.textContent.trim() + '\n\n';
            }
            
            // L·∫•y c√°c section
            const sections = container.querySelectorAll('.report-section');
            sections.forEach(section => {
                const sectionTitle = section.querySelector('.section-title');
                if (sectionTitle) {
                    text += sectionTitle.textContent.trim() + '\n';
                    text += '='.repeat(50) + '\n';
                }
                
                const items = section.querySelectorAll('.report-item');
                items.forEach(item => {
                    const strong = item.querySelector('strong');
                    if (strong) {
                        text += '\n' + strong.textContent.trim() + '\n';
                    }
                    
                    // X·ª≠ l√Ω c√°c list - ch·ªâ l·∫•y list tr·ª±c ti·∫øp trong item
                    const directLists = Array.from(item.children).filter(child => child.tagName && child.tagName.toLowerCase() === 'ul');
                    
                    directLists.forEach(ul => {
                        // Ch·ªâ l·∫•y c√°c li tr·ª±c ti·∫øp (kh√¥ng l·∫•y li trong ul con)
                        const directListItems = Array.from(ul.children).filter(child => child.tagName && child.tagName.toLowerCase() === 'li');
                        
                        directListItems.forEach(li => {
                            // T·∫°o clone ƒë·ªÉ x·ª≠ l√Ω
                            const liClone = li.cloneNode(true);
                            
                            // Lo·∫°i b·ªè t·∫•t c·∫£ ul con tr∆∞·ªõc khi l·∫•y text
                            liClone.querySelectorAll('ul').forEach(ul => ul.remove());
                            
                            // Lo·∫°i b·ªè c√°c th·∫ª HTML nh∆∞ng gi·ªØ text
                            liClone.querySelectorAll('span, strong').forEach(el => {
                                const textNode = document.createTextNode(el.textContent);
                                el.replaceWith(textNode);
                            });
                            
                            let liText = liClone.textContent.trim();
                            if (liText) {
                                text += '  ‚Ä¢ ' + liText + '\n';
                            }
                            
                            // X·ª≠ l√Ω ul con n·∫øu c√≥ (sau khi ƒë√£ x·ª≠ l√Ω text ch√≠nh)
                            const nestedUl = li.querySelector(':scope > ul');
                            if (nestedUl) {
                                const nestedItems = nestedUl.querySelectorAll(':scope > li');
                                nestedItems.forEach(nestedLi => {
                                    const nestedClone = nestedLi.cloneNode(true);
                                    // Lo·∫°i b·ªè ul con trong nested li
                                    nestedClone.querySelectorAll('ul').forEach(ul => ul.remove());
                                    nestedClone.querySelectorAll('span, strong').forEach(el => {
                                        el.replaceWith(document.createTextNode(el.textContent));
                                    });
                                    const nestedText = nestedClone.textContent.trim();
                                    if (nestedText) {
                                        text += '    - ' + nestedText + '\n';
                                    }
                                });
                            }
                        });
                    });
                });
                text += '\n';
            });
            
            // Copy v√†o clipboard
            const textToCopy = text.trim();
            navigator.clipboard.writeText(textToCopy).then(() => {
                const copyBtn = document.getElementById('copyButton');
                const copyBtnText = document.getElementById('copyButtonText');
                if (copyBtn && copyBtnText) {
                    copyBtn.classList.add('copied');
                    copyBtnText.textContent = 'ƒê√£ copy!';
                    setTimeout(() => {
                        copyBtn.classList.remove('copied');
                        copyBtnText.textContent = 'Copy b√°o c√°o';
                    }, 2000);
                }
            }).catch(err => {
                console.error('L·ªói khi copy:', err);
                // Fallback: d√πng c√°ch c≈©
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const copyBtn = document.getElementById('copyButton');
                    const copyBtnText = document.getElementById('copyButtonText');
                    if (copyBtn && copyBtnText) {
                        copyBtn.classList.add('copied');
                        copyBtnText.textContent = 'ƒê√£ copy!';
                        setTimeout(() => {
                            copyBtn.classList.remove('copied');
                            copyBtnText.textContent = 'Copy b√°o c√°o';
                        }, 2000);
                    }
                } catch (e) {
                    alert('Kh√¥ng th·ªÉ copy b√°o c√°o. Vui l√≤ng th·ª≠ l·∫°i.');
                }
                document.body.removeChild(textArea);
            });
        }

        // Load b√°o c√°o
        async function loadReport() {
            const container = document.getElementById('reportContainer');
            const copyButton = document.getElementById('copyButton');
            if (!container) return;

            container.innerHTML = '<div class="loading">ƒêang t·∫£i b√°o c√°o...</div>';
            if (copyButton) copyButton.style.display = 'none';

            try {
                const week = parseInt(document.getElementById('week').value) || 1;
                const weekRange = getWeekRangeString(week);
                
                // L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu
                const allData = await gatherAllData(week);
                
                // T·∫°o HTML b√°o c√°o
                const reportHTML = generateReportHTML(week, weekRange, allData);
                container.innerHTML = reportHTML;
                
                // Hi·ªÉn th·ªã n√∫t copy
                if (copyButton) copyButton.style.display = 'flex';
            } catch (error) {
                console.error('Error loading report:', error);
                container.innerHTML = `<div class="loading" style="color: #f5576c;">L·ªói khi t·∫£i b√°o c√°o: ${error.message}</div>`;
                if (copyButton) copyButton.style.display = 'none';
            }
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c load
        window.addEventListener('DOMContentLoaded', function() {
            const weekInput = document.getElementById('week');
            if (!weekInput) {
                console.error('week input not found');
                return;
            }
            
            setTimeout(function() {
                const currentWeek = getCurrentWeek();
                console.log('Current week calculated on page load:', currentWeek);
                
                weekInput.value = currentWeek || 1;
                updateWeekDateRange();
                loadReport();
            }, 100);
        });

        // Load l·∫°i b√°o c√°o khi thay ƒë·ªïi tu·∫ßn
        const weekInput = document.getElementById('week');
        if (weekInput) {
            weekInput.addEventListener('change', function() {
                updateWeekDateRange();
                loadReport();
            });
        }
    </script>
</body>

</html>

