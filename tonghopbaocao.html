<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>T·ªïng H·ª£p B√°o C√°o - Ban C√°n S·ª± L·ªõp</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="data.js"></script>
    <script src="config.js"></script>
    <style>
        html {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
            position: relative;
        }

        /* T·ªëi ∆∞u animation cho mobile - gi·∫£m hi·ªáu ·ª©ng ƒë·ªÉ tr√°nh lag */
        @media (max-width: 768px) {
            body {
                padding: 0;
                /* Gi·∫£m animation tr√™n mobile */
                animation: none !important;
                background-position: 0% 50%;
                /* T·ªëi ∆∞u rendering tr√™n mobile */
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                /* Safe area cho iPhone X v√† m·ªõi h∆°n */
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: max(5px, env(safe-area-inset-left));
                padding-right: max(5px, env(safe-area-inset-right));
                /* ƒê·∫£m b·∫£o kh√¥ng c√≥ horizontal scroll */
                overflow-x: hidden;
                width: 100%;
                max-width: 100vw;
            }

            .container {
                /* Safe area cho container */
                margin-bottom: env(safe-area-inset-bottom);
                margin-left: 0;
                margin-right: 0;
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                border-radius: 0;
                max-width: 100%;
                width: 100%;
            }
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
            position: relative;
        }

        .back-home {
            text-align: center;
            margin-bottom: 15px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .back-home a {
            display: inline-block;
            padding: 10px 16px;
            border-radius: 8px;
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: #fff;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            max-width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
        }

        .back-home a:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.4);
        }

        h1 {
            font-size: 2.2em;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            margin: 0 0 20px 0;
            letter-spacing: 0.5px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        h2 {
            font-size: 1.5em;
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin: 0 0 25px 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        .week-selector {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #9c27b0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .week-selector label {
            display: block;
            color: #7b1fa2;
            font-size: 1.1em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .week-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .week-controls button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
            /* Touch-friendly - minimum 44x44px for mobile */
            min-height: 44px;
            min-width: 44px;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            touch-action: manipulation;
        }

        #prevWeekBtn {
            background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3);
        }

        #prevWeekBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 125, 50, 0.4);
        }

        #nextWeekBtn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(25, 118, 210, 0.3);
        }

        #nextWeekBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(25, 118, 210, 0.4);
        }

        #week {
            flex: 1;
            min-width: 80px;
            min-height: 44px;
            padding: 12px;
            border: 2px solid #9c27b0;
            border-radius: 10px;
            background: white;
            font-weight: 600;
            font-size: 1.1em;
            text-align: center;
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            touch-action: manipulation;
        }

        /* ·∫®n n√∫t tƒÉng/gi·∫£m c·ªßa input number tr√™n mobile */
        #week::-webkit-inner-spin-button,
        #week::-webkit-outer-spin-button {
            appearance: none;
            -webkit-appearance: none;
            margin: 0;
        }

        #week_date_range {
            text-align: center;
            margin-top: 10px;
            color: #7b1fa2;
            font-weight: 600;
            font-size: 1.05em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
            width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .report-card {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
            overflow: hidden;
            position: relative;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .report-card h3 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            color: #333;
            font-size: 1.2em;
            font-weight: 600;
            line-height: 1.3;
            width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .report-content {
            min-height: 100px;
            color: #555;
            line-height: 1.8;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: left;
            white-space: pre-wrap;
            font-size: 0.95em;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
            word-break: break-word;
            hyphens: auto;
        }

        /* Khi n·ªôi dung l√† HTML (c√≥ th·∫ª <br> v√† <strong>), d√πng normal white-space */
        .report-content.html-content {
            white-space: normal;
        }

        .report-content.empty {
            color: #999;
            font-style: italic;
            text-align: center;
        }

        .report-content strong {
            font-weight: 700;
            color: #333;
        }

        .report-card.lt { border-left: 4px solid #c62828; }
        .report-card.lpht { border-left: 4px solid #4facfe; }
        .report-card.lptt { border-left: 4px solid #f5576c; }
        .report-card.lppt { border-left: 4px solid #fa709a; }
        .report-card.lpld { border-left: 4px solid #f5f7fa; }
        .report-card.tt1 { border-left: 4px solid #4caf50; }
        .report-card.tt2 { border-left: 4px solid #2196f3; }
        .report-card.tt3 { border-left: 4px solid #ff9800; }
        .report-card.tt4 { border-left: 4px solid #9c27b0; }
        .report-card.thuquy { border-left: 4px solid #667eea; }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 15px;
                border-radius: 10px;
                margin: 0;
                max-width: 100%;
            }

            .back-home {
                margin-bottom: 10px;
            }

            .back-home a {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            h1 {
                font-size: 1.5em;
                margin: 0 0 10px 0;
                line-height: 1.2;
            }

            h2 {
                font-size: 1.2em;
                margin: 0 0 15px 0;
            }

            .week-selector {
                padding: 12px;
                margin-bottom: 15px;
                border-radius: 8px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            .week-selector label {
                font-size: 0.95em;
                margin-bottom: 8px;
            }

            .week-controls {
                flex-wrap: nowrap !important;
                gap: 6px;
                width: 100%;
                max-width: 100%;
            }

            #prevWeekBtn {
                padding: 10px 12px !important;
                min-width: 45px;
                font-size: 0 !important;
                position: relative;
            }

            #prevWeekBtn::before {
                content: '‚óÄ';
                font-size: 18px !important;
                display: inline-block;
                line-height: 1;
            }

            #nextWeekBtn {
                padding: 10px 12px !important;
                min-width: 45px;
                font-size: 0 !important;
                position: relative;
            }

            #nextWeekBtn::after {
                content: '‚ñ∂';
                font-size: 18px !important;
                display: inline-block;
                line-height: 1;
            }

            #week {
                min-width: 70px !important;
                font-size: 0.95em !important;
                flex: 1 1 auto;
                padding: 10px !important;
            }

            #week_date_range {
                font-size: 0.9em;
                margin-top: 8px;
            }

            .reports-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-top: 15px;
                width: 100%;
                max-width: 100%;
                padding: 0;
                margin-left: 0;
                margin-right: 0;
            }

            .report-card {
                padding: 12px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 100%;
                margin: 0;
                box-sizing: border-box;
                overflow-x: hidden;
            }

            .report-card:hover {
                transform: none;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .report-card h3 {
                font-size: 0.95em;
                margin: 0 0 10px 0;
                padding-bottom: 6px;
                line-height: 1.2;
                width: 100%;
                max-width: 100%;
                overflow-wrap: break-word;
                word-wrap: break-word;
                word-break: break-word;
            }

            .report-content {
                min-height: 70px;
                font-size: 0.85em;
                line-height: 1.5;
                width: 100%;
                max-width: 100%;
                overflow-x: hidden;
                word-break: break-word;
                overflow-wrap: break-word;
            }

            .report-content strong {
                font-size: 0.9em;
                word-break: break-word;
            }

            .report-content.empty {
                font-size: 0.8em;
            }

            .loading {
                padding: 12px;
                font-size: 0.85em;
            }
        }

        /* Mobile nh·ªè h∆°n (iPhone SE, etc.) */
        @media (max-width: 375px) {
            body {
                padding: 0;
            }

            .container {
                padding: 10px;
                border-radius: 0;
            }

            h1 {
                font-size: 1.25em;
                margin: 0 0 8px 0;
            }

            h2 {
                font-size: 1em;
                margin: 0 0 12px 0;
            }

            .week-selector {
                padding: 10px;
                margin-bottom: 15px;
            }

            .week-selector label {
                font-size: 0.9em;
            }

            .week-controls {
                gap: 5px;
            }

            #prevWeekBtn,
            #nextWeekBtn {
                padding: 8px 10px !important;
                min-width: 40px;
            }

            #week {
                min-width: 60px !important;
                font-size: 0.9em !important;
                padding: 8px !important;
            }

            .reports-grid {
                gap: 10px;
                margin-top: 12px;
            }

            .report-card {
                padding: 10px;
                border-radius: 6px;
            }

            .report-card h3 {
                font-size: 0.9em;
                margin: 0 0 8px 0;
                padding-bottom: 5px;
            }

            .report-content {
                font-size: 0.8em;
                line-height: 1.4;
                min-height: 60px;
            }

            .report-content strong {
                font-size: 0.85em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="back-home">
            <a href="index.html">‚Üê Tr·ªü v·ªÅ trang ch·ªß</a>
        </div>
        <h1>üìä T·ªîNG H·ª¢P B√ÅO C√ÅO</h1>
        <h2>Ban C√°n S·ª± L·ªõp</h2>

        <div class="week-selector">
            <label for="week">üìÖ TU·∫¶N TH·ª®</label>
            <div class="week-controls">
                <button type="button" id="prevWeekBtn" onclick="viewPreviousWeek()">‚óÄ Tu·∫ßn tr∆∞·ªõc</button>
                <input type="number" id="week" name="week" min="1" max="35" required oninput="updateWeekDateRange(); loadAllReports();">
                <button type="button" id="nextWeekBtn" onclick="viewNextWeek()">Tu·∫ßn sau ‚ñ∂</button>
            </div>
            <div id="week_date_range"></div>
        </div>

        <div class="reports-grid" id="reportsContainer">
            <div class="report-card lt">
                <h3>üëë L·ªõp Tr∆∞·ªüng (LT)</h3>
                <div class="report-content loading" id="report-lt">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card lpht">
                <h3>üìö L·ªõp Ph√≥ H·ªçc T·∫≠p (LPHT)</h3>
                <div class="report-content loading" id="report-lpht">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card lptt">
                <h3>‚öñÔ∏è L·ªõp Ph√≥ Tr·∫≠t T·ª± (LPTT)</h3>
                <div class="report-content loading" id="report-lptt">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card lppt">
                <h3>üéµ L·ªõp Ph√≥ Phong Tr√†o (LPPT)</h3>
                <div class="report-content loading" id="report-lppt">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card lpld">
                <h3>üßπ L·ªõp Ph√≥ Lao ƒê·ªông (LPLD)</h3>
                <div class="report-content loading" id="report-lpld">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card tt1">
                <h3>üë§ T·ªï Tr∆∞·ªüng 1 (TT1)</h3>
                <div class="report-content loading" id="report-tt1">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card tt2">
                <h3>üë§ T·ªï Tr∆∞·ªüng 2 (TT2)</h3>
                <div class="report-content loading" id="report-tt2">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card tt3">
                <h3>üë§ T·ªï Tr∆∞·ªüng 3 (TT3)</h3>
                <div class="report-content loading" id="report-tt3">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card tt4">
                <h3>üë§ T·ªï Tr∆∞·ªüng 4 (TT4)</h3>
                <div class="report-content loading" id="report-tt4">ƒêang t·∫£i...</div>
            </div>
            <div class="report-card thuquy">
                <h3>üí∞ Th·ªß Qu·ªπ</h3>
                <div class="report-content loading" id="report-thuquy">ƒêang t·∫£i...</div>
            </div>
        </div>
    </div>

    <script>
        // Helper function ƒë·ªÉ l·∫•y week range string
        function getWeekRangeString(weekNumber) {
            if (typeof SCHOOL_WEEKS_CONFIG === 'undefined' || !SCHOOL_WEEKS_CONFIG) {
                return '';
            }
            if (weekNumber < 1 || weekNumber > SCHOOL_WEEKS_CONFIG.length) {
                return '';
            }
            const weekConfig = SCHOOL_WEEKS_CONFIG[weekNumber - 1];
            if (!weekConfig) return '';
            return `t·ª´ ng√†y ${weekConfig.from} ƒë·∫øn ${weekConfig.to}`;
        }

        function updateWeekDateRange() {
            const weekInput = document.getElementById('week');
            if (!weekInput) return;
            
            const weekValue = parseInt(weekInput.value) || 0;
            const weekDateRange = document.getElementById('week_date_range');
            
            if (!weekDateRange) return;
            
            if (weekValue >= 1 && weekValue <= 35) {
                const rangeString = getWeekRangeString(weekValue);
                if (rangeString) {
                    weekDateRange.textContent = rangeString;
                } else {
                    if (typeof SCHOOL_WEEKS_CONFIG === 'undefined') {
                        setTimeout(updateWeekDateRange, 200);
                    } else {
                        weekDateRange.textContent = 'Kh√¥ng t√¨m th·∫•y th√¥ng tin tu·∫ßn ' + weekValue;
                    }
                }
            } else {
                weekDateRange.textContent = '';
            }
        }

        function viewPreviousWeek() {
            const currentWeek = parseInt(document.getElementById('week').value) || 1;
            if (currentWeek > 1) {
                document.getElementById('week').value = currentWeek - 1;
                updateWeekDateRange();
                loadAllReports();
            } else {
                alert('ƒê√¢y l√† tu·∫ßn ƒë·∫ßu ti√™n!');
            }
        }

        function viewNextWeek() {
            const currentWeek = parseInt(document.getElementById('week').value) || 1;
            const maxWeek = typeof SCHOOL_WEEKS_CONFIG !== 'undefined' && SCHOOL_WEEKS_CONFIG ? SCHOOL_WEEKS_CONFIG.length : 35;
            if (currentWeek < maxWeek) {
                document.getElementById('week').value = currentWeek + 1;
                updateWeekDateRange();
                loadAllReports();
            } else {
                alert('ƒê√¢y l√† tu·∫ßn cu·ªëi c√πng!');
            }
        }

        // T√≠nh tu·∫ßn hi·ªán t·∫°i d·ª±a tr√™n ng√†y th√°ng
        function getCurrentWeek() {
            if (typeof getCurrentWeekNumber === 'function' && typeof SCHOOL_WEEKS_CONFIG !== 'undefined') {
                return getCurrentWeekNumber();
            }
            
            if (typeof SCHOOL_WEEKS_CONFIG === 'undefined' || !SCHOOL_WEEKS_CONFIG || SCHOOL_WEEKS_CONFIG.length === 0) {
                return 1;
            }
            
            const today = new Date();
            // Normalize to midnight local time ƒë·ªÉ tr√°nh l·ªói timezone
            const currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            currentDate.setHours(0, 0, 0, 0);
            
            for (let i = 0; i < SCHOOL_WEEKS_CONFIG.length; i++) {
                const weekConfig = SCHOOL_WEEKS_CONFIG[i];
                if (!weekConfig || !weekConfig.from || !weekConfig.to) continue;
                
                const [fromDay, fromMonth, fromYear] = weekConfig.from.split('/').map(Number);
                const [toDay, toMonth, toYear] = weekConfig.to.split('/').map(Number);
                
                // Ki·ªÉm tra d·ªØ li·ªáu h·ª£p l·ªá
                if (isNaN(fromDay) || isNaN(fromMonth) || isNaN(fromYear) || 
                    isNaN(toDay) || isNaN(toMonth) || isNaN(toYear)) {
                    continue;
                }
                
                const startDate = new Date(fromYear, fromMonth - 1, fromDay);
                startDate.setHours(0, 0, 0, 0);
                const endDate = new Date(toYear, toMonth - 1, toDay);
                endDate.setHours(23, 59, 59, 999); // Bao g·ªìm c·∫£ ng√†y cu·ªëi
                
                if (currentDate >= startDate && currentDate <= endDate) {
                    return weekConfig.week;
                }
            }
            
            // N·∫øu kh√¥ng t√¨m th·∫•y tu·∫ßn ch·ª©a ng√†y hi·ªán t·∫°i, t√¨m tu·∫ßn g·∫ßn nh·∫•t trong qu√° kh·ª©
            // (V√¨ Ch·ªß nh·∫≠t kh√¥ng ƒë∆∞·ª£c li·ªát k√™ trong tu·∫ßn h·ªçc, n√™n n·∫øu h√¥m nay l√† Ch·ªß nh·∫≠t
            // ho·∫∑c n·∫±m gi·ªØa c√°c tu·∫ßn, ta s·∫Ω tr·∫£ v·ªÅ tu·∫ßn v·ª´a qua)
            for (let i = SCHOOL_WEEKS_CONFIG.length - 1; i >= 0; i--) {
                const weekConfig = SCHOOL_WEEKS_CONFIG[i];
                if (!weekConfig || !weekConfig.from) continue;
                
                const [fromDay, fromMonth, fromYear] = weekConfig.from.split('/').map(Number);
                if (isNaN(fromDay) || isNaN(fromMonth) || isNaN(fromYear)) continue;
                
                const startDate = new Date(fromYear, fromMonth - 1, fromDay);
                startDate.setHours(0, 0, 0, 0);
                
                // N·∫øu tu·∫ßn n√†y b·∫Øt ƒë·∫ßu tr∆∞·ªõc ho·∫∑c b·∫±ng ng√†y hi·ªán t·∫°i, ƒë√¢y l√† tu·∫ßn g·∫ßn nh·∫•t trong qu√° kh·ª©
                if (startDate <= currentDate) {
                    return weekConfig.week;
                }
            }
            
            return 1;
        }

        // Parse CSV text th√†nh m·∫£ng d·ªØ li·ªáu
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const data = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                data.push(values);
            }
            
            return data;
        }

        // H√†m parse b√°o c√°o L·ªõp Tr∆∞·ªüng theo c·∫•u tr√∫c c·ªôt t·ª´ CSV
        function parseLTReport(csvData, week) {
            const weekStr = String(week);
            
            // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    // C·ªôt C (index 2): Th√¥ng b√°o b√™n ƒëo√†n
                    const noticeGuild = row[2] ? String(row[2]).trim() : '';
                    
                    // C·ªôt D (index 3): H·ªçc sinh v·∫Øng
                    const absentStudent = row[3] ? String(row[3]).trim() : '';
                    
                    // C·ªôt E (index 4): H·ªçc sinh tr·ªÖ
                    const lateStudent = row[4] ? String(row[4]).trim() : '';
                    
                    // C·ªôt F (index 5): Vi ph·∫°m b√™n ƒëo√†n
                    const violationGuild = row[5] ? String(row[5]).trim() : '';
                    
                    // C·ªôt G (index 6): Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau
                    const futurePlan = row[6] ? String(row[6]).trim() : '';
                    
                    // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                    let reportText = '';
                    reportText += `üì¢ <strong>Th√¥ng b√°o b√™n ƒëo√†n:</strong> ${noticeGuild || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üë§ <strong>H·ªçc sinh v·∫Øng:</strong> ${absentStudent || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚è∞ <strong>H·ªçc sinh tr·ªÖ:</strong> ${lateStudent || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚ö†Ô∏è <strong>Vi ph·∫°m b√™n ƒëo√†n:</strong> ${violationGuild || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìã <strong>Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau:</strong> ${futurePlan || 'kh√¥ng c√≥'}`;
                    
                    return { success: true, content: reportText, isHTML: true };
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Tr∆∞·ªüng t·ª´ HTML table
        function parseLTReportFromHTML(doc, week) {
            const weekStr = String(week);
            const tables = doc.querySelectorAll('table');

            if (tables.length === 0) {
                return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
            }

            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length === 0) continue;

                    const firstCell = cells[0].textContent.trim();
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // C·ªôt C (index 2): Th√¥ng b√°o b√™n ƒëo√†n
                        const noticeGuild = cells[2] ? cells[2].textContent.trim() : '';
                        
                        // C·ªôt D (index 3): H·ªçc sinh v·∫Øng
                        const absentStudent = cells[3] ? cells[3].textContent.trim() : '';
                        
                        // C·ªôt E (index 4): H·ªçc sinh tr·ªÖ
                        const lateStudent = cells[4] ? cells[4].textContent.trim() : '';
                        
                        // C·ªôt F (index 5): Vi ph·∫°m b√™n ƒëo√†n
                        const violationGuild = cells[5] ? cells[5].textContent.trim() : '';
                        
                        // C·ªôt G (index 6): Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau
                        const futurePlan = cells[6] ? cells[6].textContent.trim() : '';
                        
                        // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                        let reportText = '';
                        reportText += `üì¢ <strong>Th√¥ng b√°o b√™n ƒëo√†n:</strong> ${noticeGuild || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üë§ <strong>H·ªçc sinh v·∫Øng:</strong> ${absentStudent || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚è∞ <strong>H·ªçc sinh tr·ªÖ:</strong> ${lateStudent || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚ö†Ô∏è <strong>Vi ph·∫°m b√™n ƒëo√†n:</strong> ${violationGuild || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìã <strong>Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau:</strong> ${futurePlan || 'kh√¥ng c√≥'}`;
                        
                        return { success: true, content: reportText, isHTML: true };
                    }
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ H·ªçc T·∫≠p theo c·∫•u tr√∫c c·ªôt t·ª´ CSV
        function parseLPHTReport(csvData, week) {
            const weekStr = String(week);
            
            // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    // C·ªôt C (index 2): S·ªë ƒëi·ªÉm t·ªët
                    const goodPoints = row[2] ? String(row[2]).trim() : '';
                    
                    // C·ªôt D (index 3): S·ªë l∆∞·ª£t ph√°t bi·ªÉu
                    const participationCount = row[3] ? String(row[3]).trim() : '';
                    
                    // C·ªôt E (index 4): M√¥n h·ªçc b·ªã gi√°o vi√™n nh·∫Øc nh·ªü
                    const warnedSubject = row[4] ? String(row[4]).trim() : '';
                    
                    // C·ªôt F (index 5): Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau
                    const futurePlan = row[5] ? String(row[5]).trim() : '';
                    
                    // C·ªôt G (index 6): √ù ki·∫øn ƒë·ªÅ xu·∫•t
                    const suggestion = row[6] ? String(row[6]).trim() : '';
                    
                    // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                    let reportText = '';
                    reportText += `‚≠ê <strong>S·ªë ƒëi·ªÉm t·ªët:</strong> ${goodPoints || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚úã <strong>S·ªë l∆∞·ª£t ph√°t bi·ªÉu:</strong> ${participationCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚ö†Ô∏è <strong>M√¥n h·ªçc b·ªã gi√°o vi√™n nh·∫Øc nh·ªü:</strong> ${warnedSubject || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìã <strong>Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau:</strong> ${futurePlan || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üí° <strong>√ù ki·∫øn ƒë·ªÅ xu·∫•t:</strong> ${suggestion || 'kh√¥ng c√≥'}`;
                    
                    return { success: true, content: reportText, isHTML: true };
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ H·ªçc T·∫≠p t·ª´ HTML table
        function parseLPHTReportFromHTML(doc, week) {
            const weekStr = String(week);
            const tables = doc.querySelectorAll('table');

            if (tables.length === 0) {
                return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
            }

            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length === 0) continue;

                    const firstCell = cells[0].textContent.trim();
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // C·ªôt C (index 2): S·ªë ƒëi·ªÉm t·ªët
                        const goodPoints = cells[2] ? cells[2].textContent.trim() : '';
                        
                        // C·ªôt D (index 3): S·ªë l∆∞·ª£t ph√°t bi·ªÉu
                        const participationCount = cells[3] ? cells[3].textContent.trim() : '';
                        
                        // C·ªôt E (index 4): M√¥n h·ªçc b·ªã gi√°o vi√™n nh·∫Øc nh·ªü
                        const warnedSubject = cells[4] ? cells[4].textContent.trim() : '';
                        
                        // C·ªôt F (index 5): Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau
                        const futurePlan = cells[5] ? cells[5].textContent.trim() : '';
                        
                        // C·ªôt G (index 6): √ù ki·∫øn ƒë·ªÅ xu·∫•t
                        const suggestion = cells[6] ? cells[6].textContent.trim() : '';
                        
                        // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                        let reportText = '';
                        reportText += `‚≠ê <strong>S·ªë ƒëi·ªÉm t·ªët:</strong> ${goodPoints || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚úã <strong>S·ªë l∆∞·ª£t ph√°t bi·ªÉu:</strong> ${participationCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚ö†Ô∏è <strong>M√¥n h·ªçc b·ªã gi√°o vi√™n nh·∫Øc nh·ªü:</strong> ${warnedSubject || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìã <strong>Ph∆∞∆°ng h∆∞·ªõng tu·∫ßn sau:</strong> ${futurePlan || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üí° <strong>√ù ki·∫øn ƒë·ªÅ xu·∫•t:</strong> ${suggestion || 'kh√¥ng c√≥'}`;
                        
                        return { success: true, content: reportText, isHTML: true };
                    }
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ Tr·∫≠t T·ª± theo c·∫•u tr√∫c c·ªôt t·ª´ CSV
        function parseLPTTReport(csvData, week) {
            const weekStr = String(week);
            
            // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    // C·ªôt C (index 2): H·ªçc Sinh MTT (M·∫•t Tr·∫≠t T·ª±)
                    const disorderStudents = row[2] ? String(row[2]).trim() : '';
                    
                    // C·ªôt D (index 3): S·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt C)
                    const disorderCount = row[3] ? String(row[3]).trim() : '';
                    
                    // C·ªôt E (index 4): MTT(SDB) - M·∫•t Tr·∫≠t T·ª± ƒë√£ b·ªã ghi SDB
                    const disorderSDB = row[4] ? String(row[4]).trim() : '';
                    
                    // C·ªôt F (index 5): S·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt E)
                    const disorderSDBCount = row[5] ? String(row[5]).trim() : '';
                    
                    // C·ªôt G (index 6): Theo d√µi gi√°o vi√™n nh·∫Øc
                    const teacherWarning = row[6] ? String(row[6]).trim() : '';
                    
                    // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                    let reportText = '';
                    reportText += `üë§ <strong>H·ªçc Sinh MTT:</strong> ${disorderStudents || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${disorderCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚ö†Ô∏è <strong>MTT(SDB):</strong> ${disorderSDB || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${disorderSDBCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üì¢ <strong>Theo d√µi gi√°o vi√™n nh·∫Øc:</strong> ${teacherWarning || 'kh√¥ng c√≥'}`;
                    
                    return { success: true, content: reportText, isHTML: true };
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ Tr·∫≠t T·ª± t·ª´ HTML table
        function parseLPTTReportFromHTML(doc, week) {
            const weekStr = String(week);
            const tables = doc.querySelectorAll('table');

            if (tables.length === 0) {
                return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
            }

            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length === 0) continue;

                    const firstCell = cells[0].textContent.trim();
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // C·ªôt C (index 2): H·ªçc Sinh MTT (M·∫•t Tr·∫≠t T·ª±)
                        const disorderStudents = cells[2] ? cells[2].textContent.trim() : '';
                        
                        // C·ªôt D (index 3): S·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt C)
                        const disorderCount = cells[3] ? cells[3].textContent.trim() : '';
                        
                        // C·ªôt E (index 4): MTT(SDB) - M·∫•t Tr·∫≠t T·ª± ƒë√£ b·ªã ghi SDB
                        const disorderSDB = cells[4] ? cells[4].textContent.trim() : '';
                        
                        // C·ªôt F (index 5): S·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt E)
                        const disorderSDBCount = cells[5] ? cells[5].textContent.trim() : '';
                        
                        // C·ªôt G (index 6): Theo d√µi gi√°o vi√™n nh·∫Øc
                        const teacherWarning = cells[6] ? cells[6].textContent.trim() : '';
                        
                        // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                        let reportText = '';
                        reportText += `üë§ <strong>H·ªçc Sinh MTT:</strong> ${disorderStudents || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${disorderCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚ö†Ô∏è <strong>MTT(SDB):</strong> ${disorderSDB || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${disorderSDBCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üì¢ <strong>Theo d√µi gi√°o vi√™n nh·∫Øc:</strong> ${teacherWarning || 'kh√¥ng c√≥'}`;
                        
                        return { success: true, content: reportText, isHTML: true };
                    }
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ Phong Tr√†o theo c·∫•u tr√∫c c·ªôt t·ª´ CSV
        function parseLPPTReport(csvData, week) {
            const weekStr = String(week);
            
            // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    // C·ªôt C (index 2): T√™n phong tr√†o
                    const campaignName = row[2] ? String(row[2]).trim() : '';
                    
                    // C·ªôt D (index 3): Th·ªùi gian th·ª±c hi·ªán
                    const implementationTime = row[3] ? String(row[3]).trim() : '';
                    
                    // C·ªôt E (index 4): Ti·∫øn ƒë·ªô th·ª±c hi·ªán
                    const progress = row[4] ? String(row[4]).trim() : '';
                    
                    // C·ªôt F (index 5): Ph√¢n c√¥ng
                    const assignedStudents = row[5] ? String(row[5]).trim() : '';
                    
                    // C·ªôt G (index 6): Ng√†y thi
                    const competitionDate = row[6] ? String(row[6]).trim() : '';
                    
                    // C·ªôt H (index 7): D·ª± ki·∫øn kinh ph√≠
                    const estimatedCost = row[7] ? String(row[7]).trim() : '';
                    
                    // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                    let reportText = '';
                    reportText += `üéØ <strong>T√™n phong tr√†o:</strong> ${campaignName || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚è∞ <strong>Th·ªùi gian th·ª±c hi·ªán:</strong> ${implementationTime || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìä <strong>Ti·∫øn ƒë·ªô th·ª±c hi·ªán:</strong> ${progress || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üë• <strong>Ph√¢n c√¥ng:</strong> ${assignedStudents || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìÖ <strong>Ng√†y thi:</strong> ${competitionDate || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üí∞ <strong>D·ª± ki·∫øn kinh ph√≠:</strong> ${estimatedCost || 'kh√¥ng c√≥'}`;
                    
                    return { success: true, content: reportText, isHTML: true };
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ Phong Tr√†o t·ª´ HTML table
        function parseLPPTReportFromHTML(doc, week) {
            const weekStr = String(week);
            const tables = doc.querySelectorAll('table');

            if (tables.length === 0) {
                return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
            }

            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length === 0) continue;

                    const firstCell = cells[0].textContent.trim();
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // C·ªôt C (index 2): T√™n phong tr√†o
                        const campaignName = cells[2] ? cells[2].textContent.trim() : '';
                        
                        // C·ªôt D (index 3): Th·ªùi gian th·ª±c hi·ªán
                        const implementationTime = cells[3] ? cells[3].textContent.trim() : '';
                        
                        // C·ªôt E (index 4): Ti·∫øn ƒë·ªô th·ª±c hi·ªán
                        const progress = cells[4] ? cells[4].textContent.trim() : '';
                        
                        // C·ªôt F (index 5): Ph√¢n c√¥ng
                        const assignedStudents = cells[5] ? cells[5].textContent.trim() : '';
                        
                        // C·ªôt G (index 6): Ng√†y thi
                        const competitionDate = cells[6] ? cells[6].textContent.trim() : '';
                        
                        // C·ªôt H (index 7): D·ª± ki·∫øn kinh ph√≠
                        const estimatedCost = cells[7] ? cells[7].textContent.trim() : '';
                        
                        // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                        let reportText = '';
                        reportText += `üéØ <strong>T√™n phong tr√†o:</strong> ${campaignName || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚è∞ <strong>Th·ªùi gian th·ª±c hi·ªán:</strong> ${implementationTime || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìä <strong>Ti·∫øn ƒë·ªô th·ª±c hi·ªán:</strong> ${progress || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üë• <strong>Ph√¢n c√¥ng:</strong> ${assignedStudents || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìÖ <strong>Ng√†y thi:</strong> ${competitionDate || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üí∞ <strong>D·ª± ki·∫øn kinh ph√≠:</strong> ${estimatedCost || 'kh√¥ng c√≥'}`;
                        
                        return { success: true, content: reportText, isHTML: true };
                    }
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ Lao ƒê·ªông theo c·∫•u tr√∫c c·ªôt t·ª´ CSV
        function parseLPLDReport(csvData, week) {
            const weekStr = String(week);
            
            // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    // C·ªôt C (index 2): T·ªï tr·ª±c
                    const cleaningTeam = row[2] ? String(row[2]).trim() : '';
                    
                    // C·ªôt D (index 3): Mang gh·∫ø ra s√¢n
                    const chairTeam = row[3] ? String(row[3]).trim() : '';
                    
                    // C·ªôt E (index 4): Th·ª© 2
                    const monday = row[4] ? String(row[4]).trim() : '';
                    
                    // C·ªôt F (index 5): Th·ª© 3
                    const tuesday = row[5] ? String(row[5]).trim() : '';
                    
                    // C·ªôt G (index 6): Th·ª© 4
                    const wednesday = row[6] ? String(row[6]).trim() : '';
                    
                    // C·ªôt H (index 7): Th·ª© 5
                    const thursday = row[7] ? String(row[7]).trim() : '';
                    
                    // C·ªôt I (index 8): Th·ª© 6
                    const friday = row[8] ? String(row[8]).trim() : '';
                    
                    // C·ªôt J (index 9): Th·ª© 7
                    const saturday = row[9] ? String(row[9]).trim() : '';
                    
                    // C·ªôt K (index 10): Tr·ª±c tr·ªÖ
                    const lateDuty = row[10] ? String(row[10]).trim() : '';
                    
                    // C·ªôt L (index 11): √ù ki·∫øn
                    const feedback = row[11] ? String(row[11]).trim() : '';
                    
                    // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                    let reportText = '';
                    reportText += `üßπ <strong>T·ªï tr·ª±c:</strong> ${cleaningTeam || 'kh√¥ng c√≥'}<br>`;
                    reportText += `ü™ë <strong>Mang gh·∫ø ra s√¢n:</strong> ${chairTeam || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìÖ <strong>Th·ª© 2:</strong> ${monday || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìÖ <strong>Th·ª© 3:</strong> ${tuesday || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìÖ <strong>Th·ª© 4:</strong> ${wednesday || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìÖ <strong>Th·ª© 5:</strong> ${thursday || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìÖ <strong>Th·ª© 6:</strong> ${friday || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìÖ <strong>Th·ª© 7:</strong> ${saturday || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚è∞ <strong>Tr·ª±c tr·ªÖ:</strong> ${lateDuty || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üí¨ <strong>√ù ki·∫øn:</strong> ${feedback || 'kh√¥ng c√≥'}`;
                    
                    return { success: true, content: reportText, isHTML: true };
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o L·ªõp Ph√≥ Lao ƒê·ªông t·ª´ HTML table
        function parseLPLDReportFromHTML(doc, week) {
            const weekStr = String(week);
            const tables = doc.querySelectorAll('table');

            if (tables.length === 0) {
                return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
            }

            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length === 0) continue;

                    const firstCell = cells[0].textContent.trim();
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // C·ªôt C (index 2): T·ªï tr·ª±c
                        const cleaningTeam = cells[2] ? cells[2].textContent.trim() : '';
                        
                        // C·ªôt D (index 3): Mang gh·∫ø ra s√¢n
                        const chairTeam = cells[3] ? cells[3].textContent.trim() : '';
                        
                        // C·ªôt E (index 4): Th·ª© 2
                        const monday = cells[4] ? cells[4].textContent.trim() : '';
                        
                        // C·ªôt F (index 5): Th·ª© 3
                        const tuesday = cells[5] ? cells[5].textContent.trim() : '';
                        
                        // C·ªôt G (index 6): Th·ª© 4
                        const wednesday = cells[6] ? cells[6].textContent.trim() : '';
                        
                        // C·ªôt H (index 7): Th·ª© 5
                        const thursday = cells[7] ? cells[7].textContent.trim() : '';
                        
                        // C·ªôt I (index 8): Th·ª© 6
                        const friday = cells[8] ? cells[8].textContent.trim() : '';
                        
                        // C·ªôt J (index 9): Th·ª© 7
                        const saturday = cells[9] ? cells[9].textContent.trim() : '';
                        
                        // C·ªôt K (index 10): Tr·ª±c tr·ªÖ
                        const lateDuty = cells[10] ? cells[10].textContent.trim() : '';
                        
                        // C·ªôt L (index 11): √ù ki·∫øn
                        const feedback = cells[11] ? cells[11].textContent.trim() : '';
                        
                        // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                        let reportText = '';
                        reportText += `üßπ <strong>T·ªï tr·ª±c:</strong> ${cleaningTeam || 'kh√¥ng c√≥'}<br>`;
                        reportText += `ü™ë <strong>Mang gh·∫ø ra s√¢n:</strong> ${chairTeam || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìÖ <strong>Th·ª© 2:</strong> ${monday || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìÖ <strong>Th·ª© 3:</strong> ${tuesday || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìÖ <strong>Th·ª© 4:</strong> ${wednesday || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìÖ <strong>Th·ª© 5:</strong> ${thursday || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìÖ <strong>Th·ª© 6:</strong> ${friday || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìÖ <strong>Th·ª© 7:</strong> ${saturday || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚è∞ <strong>Tr·ª±c tr·ªÖ:</strong> ${lateDuty || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üí¨ <strong>√ù ki·∫øn:</strong> ${feedback || 'kh√¥ng c√≥'}`;
                        
                        return { success: true, content: reportText, isHTML: true };
                    }
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o Th·ªß Qu·ªπ theo c·∫•u tr√∫c c·ªôt t·ª´ CSV
        function parseThuQuyReport(csvData, week) {
            const weekStr = String(week);
            
            // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    // C·ªôt C (index 2): Ti·ªÅn Thu /1HS
                    const feePerStudent = row[2] ? String(row[2]).trim() : '';
                    
                    // C·ªôt D (index 3): s·ªë l∆∞·ª£ng (c√πng d√≤ng v·ªõi C·ªôt C)
                    const quantityPaid = row[3] ? String(row[3]).trim() : '';
                    
                    // C·ªôt E (index 4): H·ªçc sinh thi·∫øu
                    const missingStudents = row[4] ? String(row[4]).trim() : '';
                    
                    // C·ªôt F (index 5): s·ªë l∆∞·ª£ng (c√πng d√≤ng v·ªõi C·ªôt E)
                    const quantityMissing = row[5] ? String(row[5]).trim() : '';
                    
                    // C·ªôt G (index 6): Chi 1
                    const expenseName1 = row[6] ? String(row[6]).trim() : '';
                    
                    // C·ªôt H (index 7): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 1)
                    const expenseAmount1 = row[7] ? String(row[7]).trim() : '';
                    
                    // C·ªôt I (index 8): Chi 2
                    const expenseName2 = row[8] ? String(row[8]).trim() : '';
                    
                    // C·ªôt J (index 9): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 2)
                    const expenseAmount2 = row[9] ? String(row[9]).trim() : '';
                    
                    // C·ªôt K (index 10): Chi 3
                    const expenseName3 = row[10] ? String(row[10]).trim() : '';
                    
                    // C·ªôt L (index 11): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 3)
                    const expenseAmount3 = row[11] ? String(row[11]).trim() : '';
                    
                    // C·ªôt M (index 12): Chi 4
                    const expenseName4 = row[12] ? String(row[12]).trim() : '';
                    
                    // C·ªôt N (index 13): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 4)
                    const expenseAmount4 = row[13] ? String(row[13]).trim() : '';
                    
                    // C·ªôt S (index 18): T·ªïng thu
                    const totalIncome = row[18] ? String(row[18]).trim() : '';
                    
                    // C·ªôt T (index 19): T·ªïng chi
                    const totalExpense = row[19] ? String(row[19]).trim() : '';
                    
                    // C·ªôt U (index 20): s·ªë ti·ªÅn c√≤n l·∫°i
                    const totalRemaining = row[20] ? String(row[20]).trim() : '';
                    
                    // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                    let reportText = '';
                    reportText += `üí∞ <strong>Ti·ªÅn Thu /1HS:</strong> ${feePerStudent || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£ng:</strong> ${quantityPaid || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üë§ <strong>H·ªçc sinh thi·∫øu:</strong> ${missingStudents || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£ng:</strong> ${quantityMissing || 'kh√¥ng c√≥'}<br>`;
                    
                    // Hi·ªÉn th·ªã c√°c kho·∫£n chi (ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ t√™n chi)
                    if (expenseName1 || expenseAmount1) {
                        reportText += `üí∏ <strong>Chi 1:</strong> ${expenseName1 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount1 || 'kh√¥ng c√≥'}<br>`;
                    }
                    if (expenseName2 || expenseAmount2) {
                        reportText += `üí∏ <strong>Chi 2:</strong> ${expenseName2 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount2 || 'kh√¥ng c√≥'}<br>`;
                    }
                    if (expenseName3 || expenseAmount3) {
                        reportText += `üí∏ <strong>Chi 3:</strong> ${expenseName3 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount3 || 'kh√¥ng c√≥'}<br>`;
                    }
                    if (expenseName4 || expenseAmount4) {
                        reportText += `üí∏ <strong>Chi 4:</strong> ${expenseName4 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount4 || 'kh√¥ng c√≥'}<br>`;
                    }
                    
                    reportText += `<br>`;
                    reportText += `üìä <strong>T·ªïng thu:</strong> ${totalIncome || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìä <strong>T·ªïng chi:</strong> ${totalExpense || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üíµ <strong>S·ªë ti·ªÅn c√≤n l·∫°i:</strong> ${totalRemaining || 'kh√¥ng c√≥'}`;
                    
                    return { success: true, content: reportText, isHTML: true };
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o Th·ªß Qu·ªπ t·ª´ HTML table
        function parseThuQuyReportFromHTML(doc, week) {
            const weekStr = String(week);
            const tables = doc.querySelectorAll('table');

            if (tables.length === 0) {
                return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
            }

            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length === 0) continue;

                    const firstCell = cells[0].textContent.trim();
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // C·ªôt C (index 2): Ti·ªÅn Thu /1HS
                        const feePerStudent = cells[2] ? cells[2].textContent.trim() : '';
                        
                        // C·ªôt D (index 3): s·ªë l∆∞·ª£ng (c√πng d√≤ng v·ªõi C·ªôt C)
                        const quantityPaid = cells[3] ? cells[3].textContent.trim() : '';
                        
                        // C·ªôt E (index 4): H·ªçc sinh thi·∫øu
                        const missingStudents = cells[4] ? cells[4].textContent.trim() : '';
                        
                        // C·ªôt F (index 5): s·ªë l∆∞·ª£ng (c√πng d√≤ng v·ªõi C·ªôt E)
                        const quantityMissing = cells[5] ? cells[5].textContent.trim() : '';
                        
                        // C·ªôt G (index 6): Chi 1
                        const expenseName1 = cells[6] ? cells[6].textContent.trim() : '';
                        
                        // C·ªôt H (index 7): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 1)
                        const expenseAmount1 = cells[7] ? cells[7].textContent.trim() : '';
                        
                        // C·ªôt I (index 8): Chi 2
                        const expenseName2 = cells[8] ? cells[8].textContent.trim() : '';
                        
                        // C·ªôt J (index 9): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 2)
                        const expenseAmount2 = cells[9] ? cells[9].textContent.trim() : '';
                        
                        // C·ªôt K (index 10): Chi 3
                        const expenseName3 = cells[10] ? cells[10].textContent.trim() : '';
                        
                        // C·ªôt L (index 11): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 3)
                        const expenseAmount3 = cells[11] ? cells[11].textContent.trim() : '';
                        
                        // C·ªôt M (index 12): Chi 4
                        const expenseName4 = cells[12] ? cells[12].textContent.trim() : '';
                        
                        // C·ªôt N (index 13): S·ªë ti·ªÅn (c√πng d√≤ng v·ªõi Chi 4)
                        const expenseAmount4 = cells[13] ? cells[13].textContent.trim() : '';
                        
                        // C·ªôt S (index 18): T·ªïng thu
                        const totalIncome = cells[18] ? cells[18].textContent.trim() : '';
                        
                        // C·ªôt T (index 19): T·ªïng chi
                        const totalExpense = cells[19] ? cells[19].textContent.trim() : '';
                        
                        // C·ªôt U (index 20): s·ªë ti·ªÅn c√≤n l·∫°i
                        const totalRemaining = cells[20] ? cells[20].textContent.trim() : '';
                        
                        // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                        let reportText = '';
                        reportText += `üí∞ <strong>Ti·ªÅn Thu /1HS:</strong> ${feePerStudent || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£ng:</strong> ${quantityPaid || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üë§ <strong>H·ªçc sinh thi·∫øu:</strong> ${missingStudents || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£ng:</strong> ${quantityMissing || 'kh√¥ng c√≥'}<br>`;
                        
                        // Hi·ªÉn th·ªã c√°c kho·∫£n chi (ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ t√™n chi)
                        if (expenseName1 || expenseAmount1) {
                            reportText += `üí∏ <strong>Chi 1:</strong> ${expenseName1 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount1 || 'kh√¥ng c√≥'}<br>`;
                        }
                        if (expenseName2 || expenseAmount2) {
                            reportText += `üí∏ <strong>Chi 2:</strong> ${expenseName2 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount2 || 'kh√¥ng c√≥'}<br>`;
                        }
                        if (expenseName3 || expenseAmount3) {
                            reportText += `üí∏ <strong>Chi 3:</strong> ${expenseName3 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount3 || 'kh√¥ng c√≥'}<br>`;
                        }
                        if (expenseName4 || expenseAmount4) {
                            reportText += `üí∏ <strong>Chi 4:</strong> ${expenseName4 || 'kh√¥ng c√≥'} <strong>S·ªë ti·ªÅn:</strong> ${expenseAmount4 || 'kh√¥ng c√≥'}<br>`;
                        }
                        
                        reportText += `<br>`;
                        reportText += `üìä <strong>T·ªïng thu:</strong> ${totalIncome || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìä <strong>T·ªïng chi:</strong> ${totalExpense || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üíµ <strong>S·ªë ti·ªÅn c√≤n l·∫°i:</strong> ${totalRemaining || 'kh√¥ng c√≥'}`;
                        
                        return { success: true, content: reportText, isHTML: true };
                    }
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o T·ªï Tr∆∞·ªüng (d√πng chung cho TT1, TT2, TT3, TT4) theo c·∫•u tr√∫c c·ªôt t·ª´ CSV
        function parseTTReport(csvData, week) {
            const weekStr = String(week);
            
            // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp
            for (let i = 1; i < csvData.length; i++) {
                const row = csvData[i];
                if (!row || row.length === 0) continue;
                
                const firstCell = row[0] ? String(row[0]).trim() : '';
                if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                    // C·ªôt C (index 2): Kh√¥ng thu·ªôc b√†i
                    const notMemorized = row[2] ? String(row[2]).trim() : '';
                    
                    // C·ªôt D (index 3): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt C)
                    const notMemorizedCount = row[3] ? String(row[3]).trim() : '';
                    
                    // C·ªôt E (index 4): Kh√¥ng l√†m b√†i t·∫≠p
                    const noHomework = row[4] ? String(row[4]).trim() : '';
                    
                    // C·ªôt F (index 5): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt E)
                    const noHomeworkCount = row[5] ? String(row[5]).trim() : '';
                    
                    // C·ªôt G (index 6): M·∫•t tr·∫≠t t·ª±
                    const disorder = row[6] ? String(row[6]).trim() : '';
                    
                    // C·ªôt H (index 7): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt G)
                    const disorderCount = row[7] ? String(row[7]).trim() : '';
                    
                    // C·ªôt I (index 8): ƒêi tr·ªÖ
                    const late = row[8] ? String(row[8]).trim() : '';
                    
                    // C·ªôt J (index 9): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt I)
                    const lateCount = row[9] ? String(row[9]).trim() : '';
                    
                    // C·ªôt K (index 10): Vi ph·∫°m ƒëo√†n
                    const violation = row[10] ? String(row[10]).trim() : '';
                    
                    // C·ªôt L (index 11): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt K)
                    const violationCount = row[11] ? String(row[11]).trim() : '';
                    
                    // C·ªôt M (index 12): v·∫Øng
                    const absent = row[12] ? String(row[12]).trim() : '';
                    
                    // C·ªôt N (index 13): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt M)
                    const absentCount = row[13] ? String(row[13]).trim() : '';
                    
                    // C·ªôt O (index 14): ƒêi·ªÉm t·ªët
                    const goodPoints = row[14] ? String(row[14]).trim() : '';
                    
                    // C·ªôt P (index 15): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt O)
                    const goodPointsCount = row[15] ? String(row[15]).trim() : '';
                    
                    // C·ªôt Q (index 16): Ph√°t bi·ªÉu
                    const participation = row[16] ? String(row[16]).trim() : '';
                    
                    // C·ªôt R (index 17): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt Q)
                    const participationCount = row[17] ? String(row[17]).trim() : '';
                    
                    // C·ªôt S (index 18): s·ªë ƒëi·ªÉm
                    const totalPoints = row[18] ? String(row[18]).trim() : '';
                    
                    // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                    let reportText = '';
                    reportText += `üìö <strong>Kh√¥ng thu·ªôc b√†i:</strong> ${notMemorized || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${notMemorizedCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìù <strong>Kh√¥ng l√†m b√†i t·∫≠p:</strong> ${noHomework || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${noHomeworkCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚ö†Ô∏è <strong>M·∫•t tr·∫≠t t·ª±:</strong> ${disorder || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${disorderCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚è∞ <strong>ƒêi tr·ªÖ:</strong> ${late || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${lateCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üö´ <strong>Vi ph·∫°m ƒëo√†n:</strong> ${violation || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${violationCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üë§ <strong>V·∫Øng:</strong> ${absent || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${absentCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚≠ê <strong>ƒêi·ªÉm t·ªët:</strong> ${goodPoints || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${goodPointsCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `‚úã <strong>Ph√°t bi·ªÉu:</strong> ${participation || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${participationCount || 'kh√¥ng c√≥'}<br>`;
                    reportText += `üìä <strong>S·ªë ƒëi·ªÉm:</strong> ${totalPoints || 'kh√¥ng c√≥'}`;
                    
                    return { success: true, content: reportText, isHTML: true };
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m parse b√°o c√°o T·ªï Tr∆∞·ªüng t·ª´ HTML table
        function parseTTReportFromHTML(doc, week) {
            const weekStr = String(week);
            const tables = doc.querySelectorAll('table');

            if (tables.length === 0) {
                return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
            }

            for (let table of tables) {
                const rows = table.querySelectorAll('tr');
                
                for (let row of rows) {
                    const cells = row.querySelectorAll('td, th');
                    if (cells.length === 0) continue;

                    const firstCell = cells[0].textContent.trim();
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // C·ªôt C (index 2): Kh√¥ng thu·ªôc b√†i
                        const notMemorized = cells[2] ? cells[2].textContent.trim() : '';
                        
                        // C·ªôt D (index 3): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt C)
                        const notMemorizedCount = cells[3] ? cells[3].textContent.trim() : '';
                        
                        // C·ªôt E (index 4): Kh√¥ng l√†m b√†i t·∫≠p
                        const noHomework = cells[4] ? cells[4].textContent.trim() : '';
                        
                        // C·ªôt F (index 5): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt E)
                        const noHomeworkCount = cells[5] ? cells[5].textContent.trim() : '';
                        
                        // C·ªôt G (index 6): M·∫•t tr·∫≠t t·ª±
                        const disorder = cells[6] ? cells[6].textContent.trim() : '';
                        
                        // C·ªôt H (index 7): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt G)
                        const disorderCount = cells[7] ? cells[7].textContent.trim() : '';
                        
                        // C·ªôt I (index 8): ƒêi tr·ªÖ
                        const late = cells[8] ? cells[8].textContent.trim() : '';
                        
                        // C·ªôt J (index 9): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt I)
                        const lateCount = cells[9] ? cells[9].textContent.trim() : '';
                        
                        // C·ªôt K (index 10): Vi ph·∫°m ƒëo√†n
                        const violation = cells[10] ? cells[10].textContent.trim() : '';
                        
                        // C·ªôt L (index 11): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt K)
                        const violationCount = cells[11] ? cells[11].textContent.trim() : '';
                        
                        // C·ªôt M (index 12): v·∫Øng
                        const absent = cells[12] ? cells[12].textContent.trim() : '';
                        
                        // C·ªôt N (index 13): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt M)
                        const absentCount = cells[13] ? cells[13].textContent.trim() : '';
                        
                        // C·ªôt O (index 14): ƒêi·ªÉm t·ªët
                        const goodPoints = cells[14] ? cells[14].textContent.trim() : '';
                        
                        // C·ªôt P (index 15): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt O)
                        const goodPointsCount = cells[15] ? cells[15].textContent.trim() : '';
                        
                        // C·ªôt Q (index 16): Ph√°t bi·ªÉu
                        const participation = cells[16] ? cells[16].textContent.trim() : '';
                        
                        // C·ªôt R (index 17): s·ªë l∆∞·ª£t (c√πng d√≤ng v·ªõi C·ªôt Q)
                        const participationCount = cells[17] ? cells[17].textContent.trim() : '';
                        
                        // C·ªôt S (index 18): s·ªë ƒëi·ªÉm
                        const totalPoints = cells[18] ? cells[18].textContent.trim() : '';
                        
                        // T·∫°o report text v·ªõi format c√≥ nh√£n v√† HTML ƒë·ªÉ ti√™u ƒë·ªÅ in ƒë·∫≠m
                        let reportText = '';
                        reportText += `üìö <strong>Kh√¥ng thu·ªôc b√†i:</strong> ${notMemorized || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${notMemorizedCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìù <strong>Kh√¥ng l√†m b√†i t·∫≠p:</strong> ${noHomework || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${noHomeworkCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚ö†Ô∏è <strong>M·∫•t tr·∫≠t t·ª±:</strong> ${disorder || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${disorderCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚è∞ <strong>ƒêi tr·ªÖ:</strong> ${late || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${lateCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üö´ <strong>Vi ph·∫°m ƒëo√†n:</strong> ${violation || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${violationCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üë§ <strong>V·∫Øng:</strong> ${absent || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${absentCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚≠ê <strong>ƒêi·ªÉm t·ªët:</strong> ${goodPoints || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${goodPointsCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `‚úã <strong>Ph√°t bi·ªÉu:</strong> ${participation || 'kh√¥ng c√≥'} <strong>S·ªë l∆∞·ª£t:</strong> ${participationCount || 'kh√¥ng c√≥'}<br>`;
                        reportText += `üìä <strong>S·ªë ƒëi·ªÉm:</strong> ${totalPoints || 'kh√¥ng c√≥'}`;
                        
                        return { success: true, content: reportText, isHTML: true };
                    }
                }
            }
            
            return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
        }

        // H√†m ƒë·ªçc d·ªØ li·ªáu t·ª´ Google Sheet CSV
        async function fetchReportFromSheet(reportId, gid) {
            try {
                if (!gid || !PUBLISHED_SPREADSHEET_URL) {
                    return { error: 'GID ho·∫∑c PUBLISHED_SPREADSHEET_URL kh√¥ng ƒë∆∞·ª£c c·∫•u h√¨nh' };
                }

                const week = parseInt(document.getElementById('week').value) || 1;
                
                // T·∫°o URL CSV t·ª´ PUBLISHED_SPREADSHEET_URL v√† GID
                const csvUrl = `${PUBLISHED_SPREADSHEET_URL}/pub?gid=${gid}&single=true&output=csv`;
                
                // Th·ª≠ ƒë·ªçc CSV tr·ª±c ti·∫øp
                let csvText = null;
                try {
                    const response = await fetch(csvUrl, {
                        method: 'GET',
                        mode: 'cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        csvText = await response.text();
                    }
                } catch (directError) {
                    console.log(`Direct fetch failed for ${reportId}, trying proxy...`);
                }

                // N·∫øu direct fetch th·∫•t b·∫°i, th·ª≠ d√πng proxy
                if (!csvText) {
                    try {
                        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`;
                        const proxyResponse = await fetch(proxyUrl);
                        
                        if (proxyResponse.ok) {
                            const proxyData = await proxyResponse.json();
                            if (proxyData.contents) {
                                csvText = proxyData.contents;
                            }
                        }
                    } catch (proxyError) {
                        console.error(`Proxy fetch failed for ${reportId}:`, proxyError);
                    }
                }

                if (!csvText) {
                    // N·∫øu CSV kh√¥ng ƒë∆∞·ª£c, th·ª≠ ƒë·ªçc t·ª´ HTML
                    return await fetchReportFromSheetHTML(reportId, gid);
                }

                // Parse CSV
                const csvData = parseCSV(csvText);
                if (csvData.length < 2) {
                    return { empty: true, message: 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu trong sheet' };
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Tr∆∞·ªüng (LT)
                if (reportId === 'LT') {
                    return parseLTReport(csvData, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ H·ªçc T·∫≠p (LPHT)
                if (reportId === 'LPHT') {
                    return parseLPHTReport(csvData, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ Tr·∫≠t T·ª± (LPTT)
                if (reportId === 'LPTT') {
                    return parseLPTTReport(csvData, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ Phong Tr√†o (LPPT)
                if (reportId === 'LPPT') {
                    return parseLPPTReport(csvData, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ Lao ƒê·ªông (LPLD)
                if (reportId === 'LPLD') {
                    return parseLPLDReport(csvData, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho Th·ªß Qu·ªπ (ThuQuy)
                if (reportId === 'ThuQuy') {
                    return parseThuQuyReport(csvData, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho T·ªï Tr∆∞·ªüng (TT1, TT2, TT3, TT4) - d√πng chung h√†m parse
                if (reportId === 'TT1' || reportId === 'TT2' || reportId === 'TT3' || reportId === 'TT4') {
                    return parseTTReport(csvData, week);
                }

                // T√¨m d√≤ng c√≥ tu·∫ßn kh·ªõp (c·ªôt ƒë·∫ßu ti√™n th∆∞·ªùng l√† s·ªë tu·∫ßn)
                const weekStr = String(week);
                let reportText = '';
                
                for (let i = 1; i < csvData.length; i++) {
                    const row = csvData[i];
                    if (!row || row.length === 0) continue;
                    
                    const firstCell = row[0] ? String(row[0]).trim() : '';
                    if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                        // L·∫•y t·∫•t c·∫£ c√°c c·ªôt c√≥ d·ªØ li·ªáu (b·ªè qua c·ªôt ƒë·∫ßu ti√™n l√† s·ªë tu·∫ßn)
                        for (let j = 1; j < row.length; j++) {
                            const cellText = row[j] ? String(row[j]).trim() : '';
                            if (cellText && cellText !== '-' && cellText !== '' && cellText !== '0') {
                                if (reportText) reportText += '\n';
                                reportText += cellText;
                            }
                        }
                        break;
                    }
                }

                if (!reportText) {
                    return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
                }

                return { success: true, content: reportText.trim() };
            } catch (error) {
                console.error(`Error loading report ${reportId}:`, error);
                return { error: error.message || 'L·ªói khi t·∫£i d·ªØ li·ªáu' };
            }
        }

        // H√†m ƒë·ªçc d·ªØ li·ªáu t·ª´ Google Sheet HTML (fallback)
        async function fetchReportFromSheetHTML(reportId, gid) {
            try {
                if (!gid || !PUBLISHED_SPREADSHEET_URL) {
                    return { error: 'GID ho·∫∑c PUBLISHED_SPREADSHEET_URL kh√¥ng ƒë∆∞·ª£c c·∫•u h√¨nh' };
                }

                const htmlUrl = `${PUBLISHED_SPREADSHEET_URL}/pubhtml?gid=${gid}&single=true`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(htmlUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ sheet');
                }

                const data = await response.json();
                const htmlContent = data.contents;

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const tables = doc.querySelectorAll('table');

                if (tables.length === 0) {
                    return { error: 'Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu' };
                }

                const week = parseInt(document.getElementById('week').value) || 1;
                const weekStr = String(week);
                
                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Tr∆∞·ªüng (LT) t·ª´ HTML
                if (reportId === 'LT') {
                    return parseLTReportFromHTML(doc, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ H·ªçc T·∫≠p (LPHT) t·ª´ HTML
                if (reportId === 'LPHT') {
                    return parseLPHTReportFromHTML(doc, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ Tr·∫≠t T·ª± (LPTT) t·ª´ HTML
                if (reportId === 'LPTT') {
                    return parseLPTTReportFromHTML(doc, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ Phong Tr√†o (LPPT) t·ª´ HTML
                if (reportId === 'LPPT') {
                    return parseLPPTReportFromHTML(doc, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho L·ªõp Ph√≥ Lao ƒê·ªông (LPLD) t·ª´ HTML
                if (reportId === 'LPLD') {
                    return parseLPLDReportFromHTML(doc, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho Th·ªß Qu·ªπ (ThuQuy) t·ª´ HTML
                if (reportId === 'ThuQuy') {
                    return parseThuQuyReportFromHTML(doc, week);
                }

                // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho T·ªï Tr∆∞·ªüng (TT1, TT2, TT3, TT4) t·ª´ HTML - d√πng chung h√†m parse
                if (reportId === 'TT1' || reportId === 'TT2' || reportId === 'TT3' || reportId === 'TT4') {
                    return parseTTReportFromHTML(doc, week);
                }
                
                let reportText = '';

                for (let table of tables) {
                    const rows = table.querySelectorAll('tr');
                    
                    for (let row of rows) {
                        const cells = row.querySelectorAll('td, th');
                        if (cells.length === 0) continue;

                        const firstCell = cells[0].textContent.trim();
                        if (firstCell === weekStr || firstCell === `Tu·∫ßn ${week}`) {
                            for (let i = 1; i < cells.length; i++) {
                                const cellText = cells[i].textContent.trim();
                                if (cellText && cellText !== '-' && cellText !== '') {
                                    if (reportText) reportText += '\n';
                                    reportText += cellText;
                                }
                            }
                            break;
                        }
                    }
                }

                if (!reportText) {
                    return { empty: true, message: 'Kh√¥ng c√≥ b√°o c√°o cho tu·∫ßn n√†y' };
                }

                return { success: true, content: reportText.trim() };
            } catch (error) {
                console.error(`Error loading report ${reportId} from HTML:`, error);
                return { error: error.message || 'L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ HTML' };
            }
        }

        // Load b√°o c√°o cho m·ªôt ch·ª©c v·ª• c·ª• th·ªÉ
        async function loadReport(reportId, configKey) {
            const reportElement = document.getElementById(`report-${reportId.toLowerCase()}`);
            if (!reportElement) return;

            reportElement.textContent = 'ƒêang t·∫£i...';
            reportElement.classList.remove('empty');
            reportElement.classList.remove('html-content');

            try {
                // L·∫•y GID t·ª´ config.js
                let gid = null;
                
                // Map configKey sang GID t·ª´ config.js
                const gidMap = {
                    'LT': typeof LT_SHEET_GID !== 'undefined' ? LT_SHEET_GID : null,
                    'LPHT': typeof LPHT_SHEET_GID !== 'undefined' ? LPHT_SHEET_GID : null,
                    'LPTT': typeof LPTT_SHEET_GID !== 'undefined' ? LPTT_SHEET_GID : null,
                    'LPPT': typeof LPPT_SHEET_GID !== 'undefined' ? LPPT_SHEET_GID : null,
                    'LPLD': typeof LPLD_SHEET_GID !== 'undefined' ? LPLD_SHEET_GID : null,
                    'TT1': typeof TT1_SHEET_GID !== 'undefined' ? TT1_SHEET_GID : null,
                    'TT2': typeof TT2_SHEET_GID !== 'undefined' ? TT2_SHEET_GID : null,
                    'TT3': typeof TT3_SHEET_GID !== 'undefined' ? TT3_SHEET_GID : null,
                    'TT4': typeof TT4_SHEET_GID !== 'undefined' ? TT4_SHEET_GID : null,
                    'ThuQuy': typeof THUQUY_SHEET_GID !== 'undefined' ? THUQUY_SHEET_GID : null
                };

                gid = gidMap[configKey];

                if (!gid) {
                    reportElement.textContent = `GID cho ${configKey} ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh trong config.js`;
                    reportElement.classList.add('empty');
                    return;
                }

                const result = await fetchReportFromSheet(reportId, gid);

                if (result.error) {
                    reportElement.textContent = `L·ªói: ${result.error}`;
                    reportElement.classList.add('empty');
                    reportElement.classList.remove('html-content');
                } else if (result.empty) {
                    reportElement.textContent = result.message || 'Ch∆∞a c√≥ b√°o c√°o cho tu·∫ßn n√†y';
                    reportElement.classList.add('empty');
                    reportElement.classList.remove('html-content');
                } else if (result.success) {
                    // N·∫øu c√≥ isHTML flag, s·ª≠ d·ª•ng innerHTML ƒë·ªÉ render HTML, ng∆∞·ª£c l·∫°i d√πng textContent
                    if (result.isHTML) {
                        reportElement.innerHTML = result.content;
                        reportElement.classList.add('html-content');
                    } else {
                        reportElement.textContent = result.content;
                        reportElement.classList.remove('html-content');
                    }
                    reportElement.classList.remove('empty');
                }
            } catch (error) {
                reportElement.textContent = `L·ªói: ${error.message}`;
                reportElement.classList.add('empty');
                reportElement.classList.remove('html-content');
            }
        }

        // Load t·∫•t c·∫£ c√°c b√°o c√°o
        async function loadAllReports() {
            const week = document.getElementById('week').value;
            if (!week || week < 1 || week > 35) {
                return;
            }

            // Load t·∫•t c·∫£ b√°o c√°o song song
            await Promise.all([
                loadReport('LT', 'LT'),
                loadReport('LPHT', 'LPHT'),
                loadReport('LPTT', 'LPTT'),
                loadReport('LPPT', 'LPPT'),
                loadReport('LPLD', 'LPLD'),
                loadReport('TT1', 'TT1'),
                loadReport('TT2', 'TT2'),
                loadReport('TT3', 'TT3'),
                loadReport('TT4', 'TT4'),
                loadReport('ThuQuy', 'ThuQuy')
            ]);
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c load
        window.addEventListener('DOMContentLoaded', function() {
            const weekInput = document.getElementById('week');
            if (!weekInput) {
                console.error('week input not found');
                return;
            }
            
            setTimeout(function() {
                const currentWeek = getCurrentWeek();
                console.log('Current week calculated on page load:', currentWeek);
                
                weekInput.value = currentWeek || 1;
                updateWeekDateRange();
                loadAllReports();
            }, 100);
        });

        // Load l·∫°i b√°o c√°o khi thay ƒë·ªïi tu·∫ßn
        const weekInput = document.getElementById('week');
        if (weekInput) {
            weekInput.addEventListener('change', function() {
                updateWeekDateRange();
                loadAllReports();
            });
        }
    </script>
</body>

</html>

